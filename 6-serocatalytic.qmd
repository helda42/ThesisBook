---
title: "Mechanistic serological catalytic model for acquisition of natural immunity to non-typhoidal salmonella"
format:    
  pdf:
    geometry:
      - top=20mm
      - bottom=20mm
      - left=20mm
      - right=20mm
    toc: true
    number-sections: true
    colorlinks: true
    include-in-header:
      text: |
        \usepackage{typearea}
    cite-method: citeproc
    bibliography: references.bib
    csl: diabetologia.csl
editor: visual
---

## Introduction

Children exposed to enteric nontyphoidal *Salmonella* (eNTS) develop effective natural immunity against invasive disease [@nyirenda_sequential_2014, @maclennan_neglected_2008], which can inform understanding of windows in immune susceptibility to inform approaches to developing vaccine derived immunity. Understanding the age-stratified natural acquisition of immunity in relation to age-stratified asymptomatic eNTS infections and invasive disease incidence in different settings can contribute to understanding of possible correlates of protection (COP) and inform vaccine impact and implementation. High forces of infection with invasive serovars may result in incidence of invasive disease in younger age groups, compared to populations with a lower force of infection. However, cross-protection from non-invasive NTS serovars may result in protective immunity earlier in life, so that when children are exposed to an invasive strain, they have already developed robust immunity against invasive disease. Understanding these dynamics between force of infection, natural immunity and susceptibility to invasive disease is key to identifying correlates of protection for vaccine studies. It is particularly important to understand the role that naturally acquired immunity plays in protection against invasive disease as this will be important when considering the impact that vaccination may play on both asymptomatic or sub-clinical enteric NTS infections and invasive NTS disease. As naturally acquired immunity appears to be effective protection against invasive disease (as explored in chapter 1), it is important to understand how vaccine-derived immunity may impact this, for example reduce enteric NTS infections, or fecal shedding durtation and therefore may impact the force of infection of NTS from enteric infections and may reduce natural immunity. Vaccine strategy will need to understand the impacts of this to ensure that the most at risk groups are protected, whilst continuing to allow children to boost natural immunity from asymptomatic eNTS events.

Serocatalytic models have been used to understand the mechanisms behind the age-stratified serological responses to a wide range of infectious diseases including dengue[@cox_estimating_2022], malaria [@yman_antibody_2016] and pneumococcus [@lourenco_determinants_2019]. Antibody acquisition models have been used for improving the precision of serological surveillance of malaria transmission intensity with small sample sizes \[ @yman_antibody_2016\].

Modelling the number of enteric exposures leading to effective immunity could be important in understanding how to induce effective vaccine-derived immunity. Having better understanding of the mechanisms behind acquistion of immunity at a population level can inform understanding of the impacts of vaccine-derived immunity on the population.

## Methods

Serum from healthy children recruited in the community was tested for O-Ag immunoglobulin G (IgG) to *Salmonella* Typhimurium (STm) using an ELISA assay developed by GVGH [@aruta_characterization_2023], as part of the VacciNTS consortium as described in chapters 1 and 2. Samples were analysed at the Kamuzu University of Health Sciences (KUHES) laboratory, Blantyre, Malawi as described in chapter 2. The relationship between age in months and geometric mean concentrations (GMC) of anti-O-Ag STm IgGm for each 1 month age group was modeled using a serocatalytic model to the observed data.

### Modeling approach

A serotype-specific catalytic serological model was designed assuming an exponential decay of maternal antibodies with age from birth, and exposure to enteric non-typhoidal salmonella infections lead to the induction of immunity (anti-O-Ag STm IgG) through a Gompertz function relationship by age. Gompertz functions are used widely in modeling biological processes including cell growth in tumors \[ref\].

### Hypotheses to be tested by model

![Adaptation to serological catalytic model developed by Lourenco et al [@lourenco_determinants_2019]](figures/6_images/model_diag.png){#fig-serocatalytic width="599"}

### Model 1: Constant force of infection (lambda)

$$GMC(a, t)  =  mAB(a)  +  \Phi(\theta(a,t))  $$

-   a = age

-   t= time

-   mAB = maternal antibodies which decay at a rate of $\mu$ given an initial value $mAB_{0}$

-   $\theta(a,t))$ = Estimated number of exposures for individuals at age a and time t

-   $\Phi(\theta(a,t))$ = Relationship between number of estimated number of exposures and antibody response

Assumptions: Time was removed from equation if assume $\lambda(t)$ exposure over time is constant

Assume age (a) = time e.g. at 1 month of age child has been in model for 1 month of time

Obtain $\lambda(t)$ = Force of infection (FOI) = rate at which individuals become infectious (from literature - usually in units of days): $\lambda(t)=\beta(t)$

However, there has been little work done on this from what I can find. Can I get the model to estimate $\beta$ from fitting to the data?

### Probability of event using poisson distribution

Using the poisson distribution formula, the probability of observing x number of exposure events in an interval is: $$P(x) = \frac{\lambda^{x}}{x!}  e^{-\lambda}$$ Where: x = 0, 1, 2, 3..... = number of occurrences of an event in an interval $\lambda(t)$ = mean number of occurrences in the interval = event interval e = Euler's constant = 2.71828 = the base of natural logarithms

If use months as units of age...

To calculate yi(a), a = 1 month = proportion of population with i number of infections at 1 month of age; calculate poisson of a fixed $\lambda(t)$ on the 1st month

$$y_{i}(1m) = \frac{\lambda^{i}}{i!}  e^{-\lambda}$$

To calculate for a 5m old: calculate sum of poisons for subsequent 5th months:

$$y_{i}(a) = \sum \frac{\lambda^{i}a^{i}}{i!}  e^{-\lambda.a}$$ N.B. If we want to consider that $\lambda(t)$ changes with time then each $\lambda(t)$ will be incorporated for each time-age bin of exposure

### Calculate Ab by natural exposure

Using Gompertz function for growth, which exhibits exponential decay of relative growth rate:

$$ f(t) = ce^{-ke^{-rt}}$$ Where c = upper asymptote (carrying capacity) of f(t) $$ lim_{t \to \infty} ke^{-ce^{-rt}} = ke^{0} = k $$\
e = Euler's constant = 2.71828 = the base of natural logarithms

k = sets displacement along the x-axis (translates graph to left or right).

When c = log(2), f(0) = k/2, also called halfway point

r = sets the growth rate (y scaling)

t = time

Using Gompertz function, can calculate $\Phi$

$$ \Phi(\theta n_{s}(a)) = ce^{-i_{s}e^{-k_{s}n_{s}(a)}}$$ Where:

ns = number of exposures

c = will be set at constant as highest antibody titre measured in the population - if had an infinite number of exposures this would be the plateau of antibody response (upper asymptote/ carrying capacity of f(t))

ks = growth rate (y scaling)

is = number of exposures above which antibodies begins to increase (displacement along x-axis)

e = Euler's constant

a = age

Two parameters that will be fitted to the data:

k = growth rate i = number of exposures above which the antibody response will enter the growth function?

### Modeling acquisition of antibodies following natural exposure

Using Gompertz function for growth, which exhibits exponential decay of relative growth rate:

$$ f(t) = ce^{-ke^{-rt}}$$ Where c = upper asymptote (carrying capacity) of f(t) $$ lim_{t \to \infty} ke^{-ce^{-rt}} = ke^{0} = k $$\
e = Euler's constant = 2.71828 = the base of natural logarithms k = sets displacement along the x-axis (translates graph to left or right). When c = log(2), f(0) = k/2, also called halfway point r = sets the growth rate (y scaling) t = time

Using Gompertz function, can calculate $\Phi$

$$ \Phi(\theta n_{s}(a)) = ce^{-i_{s}e^{-k_{s}n_{s}(a)}}$$ Where:

ns = number of exposures

c = will be set at constant as highest antibody titre measured in the population - if had an infinite number of exposures this would be the plateau of antibody response (upper asymptote/ carrying capacity of f(t))

ks = growth rate (y scaling)

is = number of exposures above which antibodies begins to increase (displacement along x-axis)

e = Euler's constant

a = age

Two parameters that will be fitted to the data:

k = growth rate i = number of exposures above which the antibody response will enter the growth function?

### Fitting to model using Markov-Chain Monte-Carlo (MCMC)

### Model 2: Changing force of infection

In the second model, lambda was allowed to change with age, using a second gompertz curve to model a sigmoidal relationship between age and force of infection (eNTS) events.

$$ f(ns) = m_xe^{-we^{-rt}}$$ Where mx = upper limit of new infections (cumulative) by age 60 months = 40 if 1 infection every 6 weeks on average across cohort - may need to adjust for age distribution $$ lim_{t \to \infty} ke^{-ce^{-rt}} = ke^{0} = k $$\
e = Euler's constant = 2.71828 = the base of natural logarithms

w = age in months before before enter exponential phase (x-axis displacement) - weaning

r = exponential phase/ growth rate high feco-oral transmission at weaning/ crawling age

The modeled relationship between age and enteric NTS infections were compared to the observed distribution of observed eNTS events (NTS PCR and microbiological culture positive stool samples), from the same cross-sectional sample of children.

### Model comparison and diagnostics

Two models were compared; model 1 assumed a constant force of infection (FOI) throughout ages from birth to 60 months, model 2 assumed FOI changed with age in a sigmoidal relationship with age. Both models were fitted to the serological data per age-bin using a Bayesian Markov-chain Monte-Carlo (MCMC) approach, and models were compared by Pareto smoothed importance sampling (PSIS) and Widely applicable information criterion (WAIC).

```{r echo=FALSE, warning=FALSE, message=FALSE, results='show', ft.align = "centre", ft.width = 5, out.width = "5.5in"}
#| tbl-cap: Summary of serological data (IgG against O-antigen of Salmonella Typhimiruim) used for the serocatalytic model by 3 month age groups. GMC = Geometric mean concentration IgG for each agegroup.SD = Standard Deviation IgG. STm = S. Typhimurium. N.B. 1 month age groups were used for the model.
#| label: tbl-serodatsum
#| 
require(tidyverse)
require(ggplot2)
require(cowplot)
require(rio)
require(here)
library(flextable)
library(gt)
library(pacman)
pacman::p_load("ape", "bayesplot", "brms", "broom", "dagitty", "devtools", "flextable", "GGally", "ggdag", "ggdark", "ggmcmc", "ggrepel", "ggthemes", "ggtree", "ghibli", "gtools", 
               "invgamma", "loo", "patchwork", "posterior", "psych", "rcartocolor", "Rcpp", "remotes", "rstan", "santoku", "StanHeaders", "statebins", "tidybayes", "tidyverse", 
               "viridis", "viridisLite", "wesanderson")
p_load(dutchmasters, ggpomological,ggtree,urbnmapr,gganimate)
library(magrittr)
library(dplyr)
library(purrr)
library(forcats)
library(tidyr)
library(modelr)
library(ggdist)
library(tidybayes)
library(ggplot2)
library(cowplot)
library(rstan)
library(brms)
library(ggrepel)
library(RColorBrewer)
library(posterior)
library(distributional)
#remotes::install_github("michael-franke/aida-package")
library(aida)
library(rethinking)


# ##load data
# #data <- import(here("data","6_data", "sero_data_agegroup_mth.csv"))   ## serology data
# Malawi <- import(here("data", "Malawi_STmIgG_master.csv"))
# #rename(EU_all.sero = EU_all.sero)## serology data
# Kenya <- import(here("data", "kenya_STmIgG_master.csv"))   ## serology data
# BF <- import(here("data", "BF_STmIgG_master.csv"))   ## serology data
# sites <- list(Malawi, Kenya, BF)
# names(sites) <- c("Malawi", "Kenya", "BF")
# site_name <- c("Malawi", "Kenya", "BF")
# names(sites)
# 
# model_comp <- function(df, name){ 
#     dataS <- df %>% 
#       mutate(AGEGROUP_mth = cut(age_calc_months, breaks = seq(0,60,1)),
#              AGE = age_calc_months) %>% 
#       group_by(AGEGROUP_mth) %>%
#       summarise(N=n(),
#                 MIDAGE=mean(AGE, na.rm = T), ##keep the actual mean age of the groups
#                 LPS_ME=mean(log(EU_all.sero),na.rm=T),
#                 LPS_SD=sd(log(EU_all.sero),na.rm=T)) %>% 
#       ungroup() %>% 
#       arrange(MIDAGE)
#     
#     data3 <- data %>%
#       group_by(AGEGROUP_3mth) %>%
#       summarise(N=n(),
#                 MIDAGE=mean(AGE, na.rm = T), ##keep the actual mean age of the groups
#                 LPS_ME=mean(log(EU_all.sero),na.rm=T),
#                 LPS_SD=sd(log(EU_all.sero),na.rm=T)) %>%
#       ungroup() %>%
#       arrange(MIDAGE)
#     
#     ## Set fixed parameters
#     dataS$mx=1  # upper limit of new infections (cumulative) by age 60 months = 40 if 1 infection every 6 weeks on average across cohort - may need to adjust for age dist
#     dataS$r=0.2 # exponential phase where enter high feco-oral transmission at weaning/ crawling age  
#     dataS$w=3   # age in months before before enter exponential phase (x-axis displacement) - weaning 
#     dataS$phi0<- max(log(data$EU_all.sero),na.rm=T) ##prior:: the max you may get from the data
#     dataS$beta0<- 0.5 ##pri
#     dataS$lambda0<- 0.11 ##prior
#     
#     # Model 1
#     prior1 <- prior(normal(2.75,0.5), nlpar = "i") +
#       prior(normal(1,0.5), nlpar = "k") +
#       prior(normal(5,1), nlpar = "mab0")
# 
#     # Fit model using brms
#     fit1 <- brms::brm(bf(LPS_ME ~ mab0*exp(-beta0*MIDAGE) + phi0*exp(-i*exp(-k*MIDAGE*lambda0)),
#                          mab0 ~ 1,
#                          i ~ 1,
#                          k ~ 1,
#                          nl = TRUE),
#                       data = dataS, prior = prior1)
# 
#     # Extract fitted dataset + predict model compements using fitted parameters
#     c_eff_midage1 <- as.data.frame(conditional_effects(fit1)$MIDAGE)
#     posteriorSum1 <- tidybayes::tidy_draws(fit1) %>%
#       dplyr::select(starts_with("b_")) %>%
#       pivot_longer(cols = everything()) %>%
#       group_by(name) %>%
#       reframe(aida::summarize_sample_vector(value)[-1])
# 
#     posteriorSum1wide <- posteriorSum1 %>%
#       pivot_wider(names_from = name, values_from = c(2:4))
# 
#     dataSn1 <- bind_cols(dataS, posteriorSum1wide) %>%
#       mutate(mab_MEAN = mean_b_mab0_Intercept*exp(-beta0*MIDAGE),
#              mab_lo = `95%|_b_mab0_Intercept`*exp(-beta0*MIDAGE),
#              mab_hi = `|95%_b_mab0_Intercept`*exp(-beta0*MIDAGE),
#              phi_MEAN = phi0*exp(-mean_b_i_Intercept*exp(-mean_b_k_Intercept*mx*exp(-w*exp(-r*MIDAGE))*lambda0)),
#              phi_lo = phi0*exp(-`95%|_b_i_Intercept`*exp(-`95%|_b_k_Intercept`*mx*exp(-w*exp(-r*MIDAGE))*lambda0)),
#              phi_hi = phi0*exp(-`|95%_b_i_Intercept`*exp(-`|95%_b_k_Intercept`*mx*exp(-w*exp(-r*MIDAGE))*lambda0)),
#              ninf_MEAN = mx*exp(-w*exp(-r*MIDAGE))*lambda0,
#              ninf_lo = mx*exp(-w*exp(-r*MIDAGE))*lambda0,
#              ninf_hi = mx*exp(-w*exp(-r*MIDAGE))*lambda0)
# 
#     ### Model 2
#     prior2 <- prior(normal(1.46, 0.05), nlpar = "i") + # Priors = posteriors from linear model HMCMC
#       prior(normal(4,0.5), nlpar = "k") +
#       prior(normal(3,0.54), nlpar = "mab0")+
#       prior(normal(0.2,0.1), nlpar = "r") +
#       prior(normal(2,0.5), nlpar = "E") +
#       prior(normal(0.15,0.02), nlpar = "lambdaB")
# 
#     fit2 <- brms::brm(bf(LPS_ME ~ mab0*exp(-beta0*MIDAGE) + phi0*exp(-i*exp(-k*mx*exp(-w*exp(-r*MIDAGE))*lambdaB))-E,
#                          mab0 ~ 1,
#                          r ~ 1,
#                          i ~ 1,
#                          k ~ 1,
#                          E ~ 1,
#                          lambdaB ~ 1,
#                          nl = TRUE),
#                       data = dataS, prior = prior2)
#     c_eff_midage2 <- as.data.frame(conditional_effects(fit2)$MIDAGE)
#     posteriorSum2 <- tidybayes::tidy_draws(fit2) %>%
#       dplyr::select(starts_with("b_")) %>%
#       pivot_longer(cols = everything()) %>%
#       group_by(name) %>%
#       reframe(aida::summarize_sample_vector(value)[-1])
# 
#     posteriorSum2wide <- posteriorSum2 %>%
#       pivot_wider(names_from = name, values_from = c(2:4))
# 
#     dataSn2 <- bind_cols(dataS, posteriorSum2wide) %>%
#       mutate(mab_MEAN = mean_b_mab0_Intercept*exp(-beta0*MIDAGE),
#              mab_lo = `95%|_b_mab0_Intercept`*exp(-beta0*MIDAGE),
#              mab_hi = `|95%_b_mab0_Intercept`*exp(-beta0*MIDAGE),
#              phi_MEAN = phi0*exp(-mean_b_i_Intercept*exp(-mean_b_k_Intercept*mx*exp(-w*exp(-r*MIDAGE))*mean_b_lambdaB_Intercept))-mean_b_E_Intercept,
#              phi_lo = phi0*exp(-`95%|_b_i_Intercept`*exp(-`95%|_b_k_Intercept`*mx*exp(-w*exp(-r*MIDAGE))*`95%|_b_lambdaB_Intercept`))-`95%|_b_E_Intercept`,
#              phi_hi = phi0*exp(-`|95%_b_i_Intercept`*exp(-`|95%_b_k_Intercept`*mx*exp(-w*exp(-r*MIDAGE))*`|95%_b_lambdaB_Intercept`))-`|95%_b_E_Intercept`,
#              ninf_MEAN = mx*exp(-w*exp(-r*MIDAGE))*mean_b_lambdaB_Intercept,
#              ninf_lo = mx*exp(-w*exp(-r*MIDAGE))*`95%|_b_lambdaB_Intercept`,
#              ninf_hi = mx*exp(-w*exp(-r*MIDAGE))*`|95%_b_lambdaB_Intercept`)
# 
#     fit1 <- add_criterion(fit1, "waic")
#     fit2 <- add_criterion(fit2, "waic")
# 
#     # compare both models
#     loo_tab <- as.data.frame(round(loo_compare(fit1, fit2, criterion = "waic"),digits=2)) %>%
#       rownames_to_column()
#     loo_tabft <- loo_tab %>% flextable()
#     print(loo_tabft)
#     
#     export(dataS, here("data", "6_data", paste0(sep="",name,"dataS.csv")))
#     export(fit1, here("data", "6_data", paste0(sep="",name,"fit1.RData")))
#     export(fit2, here("data", "6_data", paste0(sep="",name,"fit2.RData")))
#     export(c_eff_midage1, here("data", "6_data", paste0(sep="",name,"c_eff_midage1.csv")))
#     export(c_eff_midage2, here("data", "6_data", paste0(sep="",name,"c_eff_midage2.csv")))
#     export(dataSn1, here("data", "6_data", paste0(sep="",name,"dataSn1.csv")))
#     export(dataSn2, here("data", "6_data", paste0(sep="",name,"dataSn2.csv")))
#     export(loo_tab, here("data", "6_data", paste0(sep="",name,"loo_tab.csv")))
# 
# }
# lapply(names(sites), function(name) model_comp(sites[[name]], name))


gg_fit_func <- function(dataS, c_eff_midage){
  g <- ggplot() +
  geom_ribbon(aes(x=MIDAGE, ymin=exp(LPS_ME-LPS_SD), ymax=exp(LPS_ME+LPS_SD)), alpha=0.3, fill="red",data=dataS) +
  geom_ribbon(aes(x=MIDAGE, ymin=exp(lower__), ymax=exp(upper__)), alpha=0.3, fill='blue', data=c_eff_midage) +
  #geom_point(aes(x=MIDAGE, y=estimate__),fill="blue", data=c_eff_midage) +
  geom_point(aes(x=MIDAGE, y=exp(LPS_ME)),colour="blue", data=dataS) +
  theme_bw() +
  xlab("Age (months)") +
  ylab("Anti-STm IgG (EU/ml)") +
  scale_y_log10(labels = prettyNum) +
  ggtitle("LPS IgG titres by age: model vs data - changing FOI") +
  scale_x_continuous(breaks = c(seq(0,60,5))) +
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=10,face="bold"),
        plot.title = element_text(size=10))
}

gg_ninffuncum <- function(dataSn){
  gg_cum_ninf<- ggplot(dataSn) +
    geom_ribbon(aes(x=MIDAGE, ymin=ninf_lo*MIDAGE, ymax=ninf_hi*MIDAGE), alpha=0.3, fill="goldenrod") +
    geom_point(aes(x=MIDAGE, y=ninf_MEAN*MIDAGE), colour="goldenrod3") +
    theme_bw() +
    xlab("Mid-age in months") +
    ylab("Number of infections") +
    ggtitle("Number of infections by age") +
    scale_x_continuous(breaks = c(seq(0,60,5))) +
    theme(axis.text=element_text(size=10),
          axis.title=element_text(size=10,face="bold"),
          plot.title = element_text(size=10))
}

gg_ninffunc <- function(dataSn){
  gg_ninf<- ggplot(dataSn) +
    geom_ribbon(aes(x=MIDAGE, ymin=ninf_lo, ymax=ninf_hi), alpha=0.3, fill="goldenrod") +
    geom_point(aes(x=MIDAGE, y=ninf_MEAN), colour="goldenrod3") +
    theme_bw() +
    xlab("Mid-age in months") +
    ylab("Number of infections") +
    ggtitle("Percentage of children with eNTS in each age group") +
    scale_x_continuous(breaks = c(seq(0,60,5))) +
    theme(axis.text=element_text(size=10),
          axis.title=element_text(size=10,face="bold"),
          plot.title = element_text(size=10))
}

gg_mab_phi_fun<- function(dataSn){
  gg_mab_phi<- ggplot(dataSn) +
    geom_ribbon(aes(x=MIDAGE, ymin=exp(mab_lo), ymax=exp(mab_hi)), col='pink', alpha=0.3) +
    geom_point(aes(x=MIDAGE, y=exp(mab_MEAN)), col='pink') +
    geom_ribbon(aes(x=MIDAGE, ymin=exp(phi_lo), ymax=exp(phi_hi)), col='gold', alpha=0.3) +
    geom_point(aes(x=MIDAGE, y=exp(phi_MEAN)), col='gold') +
    theme_bw() +
    xlab("Mid-age in months") +
    ylab("Anti-STm LPS IgG titers (log)") +
    scale_y_log10(labels = prettyNum) +
    ggtitle("Mab and Theta (θ) by age") +
    scale_x_continuous(breaks = c(seq(0,60,5))) +
    theme(axis.text=element_text(size=10),
          axis.title=element_text(size=10,face="bold"),
          plot.title = element_text(size=10))
}

no <- c("1", "2")
co <- c("Malawi", "Kenya", "BF")
modelLs <- list()
plotLs <- list()
plotLsninf <- list()
plotLsninfcum <- list()
plotLsmabphi <- list()

for(n in no){
  for(c in co){
    modelLs[[c]]$dataS <- import(here("data", "6_data", paste(sep="",c,"dataS.csv")))#
    modelLs[[n]][[c]]$fit <- import_list(here("data", "6_data", paste(sep="",c,"fit",n,".RData")))#
    modelLs[[n]][[c]]$c_eff_midage <- import(here("data", "6_data", paste(sep="",c,"c_eff_midage",n,".csv")))#
    modelLs[[n]][[c]]$dataSn <- import(here("data", "6_data", paste(sep="",c,"dataSn",n,".csv")))#
    plotLs[[n]][[c]] <- gg_fit_func(modelLs[[c]]$dataS, modelLs[[n]][[c]]$c_eff_midage)
    plotLsninf[[n]][[c]] <- gg_ninffunc(modelLs[[n]][[c]]$dataSn)
    plotLsninfcum[[n]][[c]] <- gg_ninffuncum(modelLs[[n]][[c]]$dataSn)
    plotLsmabphi[[n]][[c]] <- gg_mab_phi_fun(modelLs[[n]][[c]]$dataSn)
  }
}
##load data
#data <- import(here("data","6_data", "sero_data_agegroup_mth.csv"))   ## serology data
data <- import(here("data","6_data", "Malawi_STmIgG_master.csv")) %>%
  mutate(AGEGROUP_mth = cut(age_calc_months, breaks = seq(0,60,1)),
         AGE = age_calc_months) 

data3 <- data %>% 
  group_by(AGEGROUP_3mth) %>%
  summarise(N=n(),
            MIDAGE=mean(AGE, na.rm = T), ##keep the actual mean age of the groups
            LPS_ME=mean(log(EU_all.sero),na.rm=T),
            LPS_SD=sd(log(EU_all.sero),na.rm=T)) %>% 
  ungroup() %>% 
  arrange(MIDAGE)

flextable(data3) %>% 
  fontsize(i = 1, size = 8, part = "header") %>%   # adjust font size of header
  bold(i = 1, bold = TRUE, part = "header") %>%    # adjust bold face of header
  fontsize(size = 8, part = "body") %>%  # adjust font size of header
  set_header_labels(         # Rename the columns in original header row
    AGEGROUP_3mth = "Age Group (month range)",
    N = "Number of children",
    MIDAGE = "Midage",
    LPS_ME = "GMC anti-STm IgG",
    LPS_SD = "SD anti-STm IgG"
  ) %>% 
  autofit()

total <- data %>% 
  summarise(n())
```

## Results

### Descriptive analysis

Cross-sectional samples were analysed for `{r} total` Malawian children 0-60 months recruited in the SAiNTS study, recruited between 9th January 2021 and 30th May 2022. Antibody responses to *Salmonella* typhimurium (STm) O-antigen IgG were used to fit the model. The geometric mean concentration (GMC) of STm OAg IgG for each 3 month age group is shown in @tbl-serodatsum. The model was fitted to GMC for 1 month age groups (0 - 60 months), allowing the model to find the values of i, k and mab that best fit the observed data. The priors for i, k, mab were based on informative priors estimated from previous data [@nyirenda_sequential_2014]?? For some level of restricted prior.

```{r echo=FALSE, warning=FALSE, message=FALSE, results=FALSE, fig.align = "centre",fig.height=5, fig.width = 5.5, out.width = "6in"}
#| fig-cap: Model 1 outputs using Markov Chain Monte Carlo (MCMC) to estimate model parameters, posterior chains and posterior distributions of parameters i, k, and mab
#| label: fig-posteriors1

theme_set(
  theme_base(base_size = 12) +
    theme(text = element_text(family = "Times"),
          axis.text = element_text(family = "Times"),
          axis.ticks = element_line(linewidth = 0.25),
          axis.ticks.length = unit(0.1, "cm"),
          panel.background = element_rect(linewidth = 0.1),
          plot.background = element_blank(),
    )
)
# Summary of posterior distributions
dataS <- modelLs$Malawi$dataS
dataSn1 <- modelLs$`1`$Malawi$dataSn
dataSn2 <- modelLs$`2`$Malawi$dataSn
c_eff_midage1 <- modelLs$`1`$Malawi$c_eff_midage
c_eff_midage2 <- modelLs$`2`$Malawi$c_eff_midage
fit1 <- modelLs$`1`$Malawi$fit
fit2 <- modelLs$`2`$Malawi$fit

i_mean1 <- round(dataSn2$mean_b_i_Intercept, digits=2)[1] 
i_95CI1 <- paste0(sep="","(", round(dataSn1$`95%|_b_i_Intercept`,digits=2)," - ", round(dataSn1$`|95%_b_i_Intercept`,digits=2),")")[1]
k_mean1 <- round(dataSn1$mean_b_k_Intercept, digits=2)[1]
k_95CI1 <-  paste0(sep="","(", round(dataSn1$`95%|_b_k_Intercept`,digits=2)," - ", round(dataSn1$`|95%_b_k_Intercept`,digits=2),")")[1]
mab_mean1 <- round(dataSn1$mean_b_mab0_Intercept, digits=2)[1]
mab_95CI1 <-paste0(sep="","(", round(dataSn1$`95%|_b_mab0_Intercept`,digits=2)," - ", round(dataSn1$`|95%_b_mab0_Intercept`,digits=2),")")[1]

i_mean2 <- round(dataSn2$mean_b_i_Intercept, digits=2)[1]
i_95CI2 <- paste0(sep="","(", round(dataSn2$`95%|_b_i_Intercept`,digits=2)," - ", round(dataSn2$`|95%_b_i_Intercept`,digits=2),")")[1]
k_mean2 <- round(dataSn2$mean_b_k_Intercept, digits=2)[1]
k_95CI2 <-  paste0(sep="","(", round(dataSn2$`95%|_b_k_Intercept`,digits=2)," - ", round(dataSn2$`|95%_b_k_Intercept`,digits=2),")")[1]
mab_mean2 <- round(dataSn2$mean_b_mab0_Intercept, digits=2)[1]
mab_95CI2 <-paste0(sep="","(", round(dataSn2$`95%|_b_mab0_Intercept`,digits=2)," - ", round(dataSn2$`|95%_b_mab0_Intercept`,digits=2),")")[1]

summary(fit1$fit)
postsum1 <- as.data.frame(fit1$fit) %>% ## posteriors
  select(1:5) %>% 
  pivot_longer(cols = everything(), names_to = "variable", values_to = "value")
gg_hist <- ggplot(postsum1, aes(x=value))+
      geom_histogram(fill="lightblue",colour="black",lwd=0.2)+
      facet_wrap(~variable, nrow = 7, scales = "free") +
      labs(x = "Value", y = "Count")
chains_plot <- as_draws_df(fit1$fit) %>% 
  mcmc_trace(pars = vars(b_mab0_Intercept:sigma), facet_args = list(ncol = 1, strip.position = "left"))+
  #scale_color_pomological() +
  labs(title = "Trace plots")#+
  #theme_pomological_fancy(base_family = "Marck Script") 
plot_grid(gg_hist, chains_plot,ncol=2)
```

### Model 1: Constant force of infection

Model fitting to the observed antibody data is shown in @fig-posteriors1 , @tbl-serodatsum, @fig-fit1. The posterior chains are shown in panel A @fig-posteriors1. The posterior distributions were i, k and mab are shown in @fig-chains1 panels B-D; the mean for i was `{r} i_mean1`, with 95% credible intervals (CI) `{r} i_95CI1`, k mean was `{r} k_mean1` & 95% CI `{r} k_95CI1`, and mab mean was `{r} mab_mean1` & sd`{r} mab_95CI1`. The model fit for the individual model components mab (maternal antibody decay) and phi (acquisition of natural immunity following eNTS exposure) are shown in @fig-fit1

### Model 2: Changing force of infection with age

The posterior distributions were i, k and mab are shown in @fig-posteriors2 panels B-D; the mean for i was `{r} i_mean2`, with 95% credible intervals (CI) `{r} i_95CI2`, k mean was `{r} k_mean2` & 95% CI `{r} k_95CI2`, and mab mean was `{r} mab_mean2` & sd`{r} mab_95CI2`. The model fit for the individual model components mab (maternal antibody decay) and phi (acquisition of natural immunity following eNTS exposure) are shown in @fig-fit2

\newpage

<!-- changing the orientation to landscape --------------------------------- -->

```{=tex}
\KOMAoptions{usegeometry, paper=landscape,pagesize}
\recalctypearea
```
```{r echo=FALSE, warning=FALSE, message=FALSE, results=FALSE, fig.align = "centre", fig.height=7, fig.width = 7.5, out.width = "8in"}
#| fig-cap: Model 1 fit, blue points are fitted GMC by age band, blue shaded area are 95% prediction intervals, pink points are observed GMC, pink shaded area are 95% prediction intervals.
#| label: fig-fit1

ninfM1 <- gg_ninffunc(dataSn1)
gg_ninf1<- gg_ninffunc(dataSn1)
gg_cum_ninf1<- gg_ninffuncum(dataSn1)
gg_mab_phi1<- gg_mab_phi_fun(dataSn1)
gg_fit1<- gg_fit_func(dataS, c_eff_midage1)

plot1 <- plot_grid(gg_mab_phi1, gg_ninf1,gg_cum_ninf1, nrow=1)
print(plot_grid(plot1, gg_fit1, nrow=2, labels="AUTO", rel_heights=c(1,2)))

```

\newpage

<!-- changing the orientation to portrait --------------------------------- -->

```{=tex}
\KOMAoptions{paper=portrait,pagesize}
\recalctypearea
```
```{r echo=FALSE, warning=FALSE, message=FALSE, results=FALSE, fig.align = "centre", fig.height=6, fig.width = 5, out.width = "5.5in"}
#| fig-cap: Model 2 outputs using Markov Chain Monte Carlo (MCMC) to estimate model parameters; posterior chains and posterior distributions of parameters i, k, and mab
#| label: fig-posteriors2

# plot posteriors
summary(fit2$fit)
postsum2 <- as.data.frame(fit2$fit) %>% ## posteriors
  select(1:7) %>% 
  pivot_longer(cols = everything(), names_to = "variable", values_to = "value")
gg_hist <- ggplot(postsum2, aes(x=value))+
      geom_histogram(fill="lightblue",colour="black",lwd=0.2)+
      facet_wrap(~variable, nrow = 7, scales = "free") +
      labs(x = "Value", y = "Count")
chains_plot <- as_draws_df(fit2$fit) %>% 
  mcmc_trace(pars = vars(b_mab0_Intercept:sigma), facet_args = list(ncol = 1, strip.position = "left"))+
  #scale_color_pomological() +
  labs(title = "Trace plots") #+
  #theme_pomological_fancy(base_family = "Marck Script") 
plot_grid(gg_hist, chains_plot,ncol=2)
```

\newpage

<!-- changing the orientation to landscape --------------------------------- -->

```{=tex}
\KOMAoptions{paper=landscape,pagesize}
\recalctypearea
```
```{r echo=FALSE, warning=FALSE, message=FALSE, results=FALSE, fig.align = "centre", fig.height=7, fig.width = 8, out.width = "8.5in"}
#| fig-cap: Model fit, blue points are fitted GMC by age band, blue shaded area are 95% prediction intervals, pink points are observed GMC, pink shaded area are 95% prediction intervals.
#| label: fig-fit2

ninfM2 <- gg_ninffunc(dataSn2)
gg_ninf2<- gg_ninffunc(dataSn2)
gg_cum_ninf2<- gg_ninffuncum(dataSn2)
gg_mab_phi2<- gg_mab_phi_fun(dataSn2)
gg_fit2<- gg_fit_func(dataS, c_eff_midage2)

plot1 <- plot_grid(gg_mab_phi2, gg_ninf2,gg_cum_ninf2, nrow=1)
print(plot_grid(plot1, gg_fit2, nrow=2, labels="AUTO", rel_heights=c(1,2)))
```

\newpage

```{r echo=FALSE, warning=FALSE, message=FALSE, ft.align = "centre", ft.height=6, ft.width = 5, out.width = "5.5in"}
#| tbl-cap: Model comparison using leave one out
#| label: tbl-loo

# loo <- loo(fit1, fit2) 
# loo_tab <- as.data.frame(round(loo$diffs, digits = 2))
# loo_tab %>% gt()
# fit1 <- add_criterion(fit1$fit, "waic")
# fit2 <- add_criterion(fit2, "waic")
# 
# # compare both models
# loo_tab <- as.data.frame(round(loo_compare(fit1, fit2, criterion = "waic"),digits=2)) %>% 
#   rownames_to_column()
# loo_tab %>% flextable()
```

```{r echo=FALSE, warning=FALSE, message=FALSE, ft.align = "centre", ft.height=6, ft.width = 5, out.width = "5.5in"}
#| tbl-cap: Model 3 fit for number of infections by age
#| label: tbl-ninfall
#| 
# ninf_all <- ninfM1 %>% 
#   left_join(ninfM2) %>% 
#   gt()
#ninf_all
```

```{r echo=FALSE, warning=FALSE, message=FALSE, ft.align = "centre", ft.height=6, ft.width = 5, out.width = "5.5in"}
#| tbl-cap: Model comparison using leave one out
#| label: tbl-sites
### Functions to run models and comparisons are in seromultilevel modelling project
loo_all <- import(here("data", "6_data","loo_all.csv"))
loo_all %>% flextable()
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results=FALSE, fig.align = "centre", fig.height=7, fig.width = 8, out.width = "8.5in"}
#| fig-cap: Model fit, blue points are fitted GMC by age band, blue shaded area are 95% prediction intervals, pink points are observed GMC, pink shaded area are 95% prediction intervals.
#| label: fig-fitsites
#plot_ls <- list()

panel1 <- do.call("plot_grid", c(plotLs$`2`, ncol=2, labels="AUTO", label_size=8))
print(panel1)

```

\newpage

<!-- changing the orientation to portrait --------------------------------- -->

```{=tex}
\KOMAoptions{paper=portrait,pagesize}
\recalctypearea
```
Model 2 was selected as the best fit model, supporting the hypothesis that the relationship of exposure to eNTS is consistent with a changing (sigmoidal) FOI with age, as reflected in O4 OAg IgG responses in children. This model estimated that on average at birth children were experiencing 0.2 (0.18 – 0.22) eNTS average infections capable of inducing a serotype specific serological response, increasing to 2 (95% CI 1.1 to 3.0) by 6 months of age and 4 (95% CI 2.1 to 5.7) by 12 months of age, plateauing at 5 (95% CI 2.2 to 7.1) eNTS infections cumulatively by age 20 - 60 months.

## Models for other sites

## Discussion

Model fit was improved assuming FOI increased around age of weaning (4-6 months); this is consistent with the observed age-stratified point prevalence of eNTS detected on stool microbiology in the same study cohort. Next steps include modeling age-stratified serological responses versus disease incidence, and cross-validation considering risk factors and epidemiological setting. Enteric NTS exposure events continue throughout childhood, however, anti-LPS IgG and SBA plateau, suggesting that these serological markers of immunity do not represent protection against enteric infections.

Data from Kenya indicates asymptomatic exposures

\*\* Could try fitting other vaccints sites to predict exposure?? understand how exposure impacts on age-patterns of disease. Make inferences about FOI in different settings/ acquisition of immunity Malaria??

Can infer O4 positivecross-protection? Not enough data...can compare in the groups we do have data for?

Limitations

Does not explicitly model time/ changes in FOI with time

## Conclusions
