---
title: "Mechanistic serological catalytic model for acquisition of natural immunity to non-typhoidal salmonella"
format:    
  pdf:
    mainfont: Didot
    linestretch: 1.5   # Set line spacing to 1.5
    geometry:
      - top=20mm
      - bottom=20mm
      - left=20mm
      - right=20mm
    toc: true
    number-sections: true
    colorlinks: true
    include-in-header:
      text: |
        \usepackage{typearea}
    cite-method: citeproc
    bibliography: references.bib
    csl: diabetologia.csl
editor: visual
---

## Introduction

Children exposed to enteric nontyphoidal *Salmonella* (eNTS) develop effective natural immunity against invasive disease [@nyirenda_sequential_2014, @maclennan_neglected_2008], which can inform understanding of windows in immune susceptibility to inform approaches to developing vaccine derived immunity. Understanding the age-stratified natural acquisition of immunity in relation to age-stratified asymptomatic eNTS infections and invasive disease incidence in different settings can contribute to understanding of possible correlates of protection (COP) and inform vaccine impact and implementation. High forces of infection with invasive serovars may result in incidence of invasive disease in younger age groups, compared to populations with a lower force of infection. However, cross-protection from non-invasive NTS serovars may result in protective immunity earlier in life, so that when children are exposed to an invasive strain, they have already developed robust immunity against invasive disease. Understanding these dynamics between force of infection, natural immunity and susceptibility to invasive disease is key to identifying correlates of protection for vaccine studies. It is particularly important to understand the role that naturally acquired immunity plays in protection against invasive disease as this will be important when considering the impact that vaccination may play on both asymptomatic or sub-clinical enteric NTS infections and invasive NTS disease. As naturally acquired immunity appears to be effective protection against invasive disease (as explored in chapter 1), it is important to understand how vaccine-derived immunity may impact this, for example reduce enteric NTS infections, or fecal shedding durtation and therefore may impact the force of infection of NTS from enteric infections and may reduce natural immunity. Vaccine strategy will need to understand the impacts of this to ensure that the most at risk groups are protected, whilst continuing to allow children to boost natural immunity from asymptomatic eNTS events.

Serocatalytic models have been used to understand the mechanisms behind the age-stratified serological responses to a wide range of infectious diseases including dengue[@cox_estimating_2022], malaria [@yman_antibody_2016] and pneumococcus [@lourenco_determinants_2019]. Antibody acquisition models have been used for improving the precision of serological surveillance of malaria transmission intensity with small sample sizes \[ @yman_antibody_2016\].

Modelling the number of enteric exposures leading to effective immunity could be important in understanding how to induce effective vaccine-derived immunity. Having better understanding of the mechanisms behind acquistion of immunity at a population level can inform understanding of the impacts of vaccine-derived immunity on the population.

## Methods

Serum from healthy children recruited in the community was tested for O-Ag immunoglobulin G (IgG) to *Salmonella* Typhimurium (STm) using an ELISA assay developed by GVGH [@aruta_characterization_2023], as part of the VacciNTS consortium as described in chapters 1 and 2. Samples were analysed at the Kamuzu University of Health Sciences (KUHES) laboratory, Blantyre, Malawi as described in chapter 2. The relationship between age in months and geometric mean concentrations (GMC) of anti-O-Ag STm IgGm for each 1 month age group was modeled using a serocatalytic model to the observed data.

### Modeling approach

A serotype-specific catalytic serological model was designed assuming an exponential decay of maternal antibodies with age from birth, and exposure to enteric non-typhoidal salmonella infections lead to the induction of immunity (anti-O-Ag STm IgG) through a Gompertz function relationship by age. Gompertz functions are used widely in modeling biological processes including cell growth in tumors \[ref\].

### Hypotheses to be tested by model

![Adaptation to serological catalytic model developed by Lourenco et al [@lourenco_determinants_2019]](figures/6_images/model_diag.png){#fig-serocatalytic width="599"}

### Model 1: Constant force of infection (lambda)

$$GMC(a, t)  =  mAB(a)  +  \Phi(\theta(a,t))  $$

-   a = age

-   t= time

-   mAB = maternal antibodies which decay at a rate of $\mu$ given an initial value $mAB_{0}$

-   $\theta(a,t))$ = Estimated number of exposures for individuals at age a and time t

-   $\Phi(\theta(a,t))$ = Relationship between number of estimated number of exposures and antibody response

Assumptions: Time was removed from equation if assume $\lambda(t)$ exposure over time is constant

Assume age (a) = time e.g. at 1 month of age child has been in model for 1 month of time

Obtain $\lambda(t)$ = Force of infection (FOI) = rate at which individuals become infectious (from literature - usually in units of days): $\lambda(t)=\beta(t)$

However, there has been little work done on this from what I can find. Can I get the model to estimate $\beta$ from fitting to the data?

### Probability of event using poisson distribution

Using the poisson distribution formula, the probability of observing x number of exposure events in an interval is: $$P(x) = \frac{\lambda^{x}}{x!}  e^{-\lambda}$$ Where: x = 0, 1, 2, 3..... = number of occurrences of an event in an interval $\lambda(t)$ = mean number of occurrences in the interval = event interval e = Euler's constant = 2.71828 = the base of natural logarithms

If use months as units of age...

To calculate yi(a), a = 1 month = proportion of population with i number of infections at 1 month of age; calculate poisson of a fixed $\lambda(t)$ on the 1st month

$$y_{i}(1m) = \frac{\lambda^{i}}{i!}  e^{-\lambda}$$

To calculate for a 5m old: calculate sum of poisons for subsequent 5th months:

$$y_{i}(a) = \sum \frac{\lambda^{i}a^{i}}{i!}  e^{-\lambda.a}$$ N.B. If we want to consider that $\lambda(t)$ changes with time then each $\lambda(t)$ will be incorporated for each time-age bin of exposure

### Calculate Ab by natural exposure

Using Gompertz function for growth, which exhibits exponential decay of relative growth rate:

$$ f(t) = ce^{-ke^{-rt}}$$ Where c = upper asymptote (carrying capacity) of f(t) $$ lim_{t \to \infty} ke^{-ce^{-rt}} = ke^{0} = k $$\

-   e = Euler's constant = 2.71828 = the base of natural logarithms

-   k = sets displacement along the x-axis (translates graph to left or right).

-   When c = log(2), f(0) = k/2, also called halfway point

-   r = sets the growth rate (y scaling)

-   t = time

Using Gompertz function, can calculate $\Phi$

$$ \Phi(\theta n_{s}(a)) = ce^{-i_{s}e^{-k_{s}n_{s}(a)}}$$ Where:

-   ns = number of exposures

-   c = will be set at constant as highest antibody titre measured in the population - if had an infinite number of exposures this would be the plateau of antibody response (upper asymptote/ carrying capacity of f(t))

-   ks = growth rate (y scaling)

-   is = number of exposures above which antibodies begins to increase (displacement along x-axis)

-   e = Euler's constant

-   a = age

-   Two parameters that will be fitted to the data:

-   k = growth rate i = number of exposures above which the antibody response will enter the growth function?

    ### Modeling acquisition of antibodies following natural exposure

Using Gompertz function for growth, which exhibits exponential decay of relative growth rate:

$$ f(t) = ce^{-ke^{-rt}}$$\
$$ lim_{t \to \infty} ke^{-ce^{-rt}} = ke^{0} = k $$\
e = Euler's constant = 2.71828 = the base of natural logarithms

k = sets displacement along the x-axis (translates graph to left or right).

c = upper asymptote (carrying capacity) of f(t)

r = sets the growth rate (y scaling)

t = time

Using Gompertz function, can calculate $\Phi$

$$ \Phi(\theta n_{s}(a)) = ce^{-i_{s}e^{-k_{s}n_{s}(a)}} - E$$ Where:

-   ns = number of exposures

-   c = will be set at constant as highest antibody titre measured in the population - if had an infinite number of exposures this would be the plateau of antibody response (upper asymptote/ carrying capacity of f(t))

-   ks = growth rate (y scaling)

-   is = number of exposures above which antibodies begins to increase (displacement along x-axis)

-   e = Euler's constant

-   a = age

-   E = constant

Two parameters that will be fitted to the data:

k = growth rate

i = number of exposures above which the antibody response will enter the growth phase (exponential growth)

### Model 2: Changing force of infection

In the second model, lambda was allowed to change with age, using a second gompertz curve to model a sigmoidal relationship between age and force of infection (eNTS) events.

$$ f(t) = m_xe^{-we^{-rt}\lambda_b} - E $$ Where mx = upper limit of new infections (cumulative) by age 60 months = 40 if 1 infection every 6 weeks on average across cohort - may need to adjust for age distribution $$ lim_{t \to \infty} ke^{-ce^{-rt}} = ke^{0} = k $$\

-   e = Euler's constant = 2.71828 = the base of natural logarithms

-   w = age in months before before enter exponential phase (x-axis displacement) - weaning

-   r = exponential phase/ growth rate high feco-oral transmission at weaning/ crawling age

-   E = constant

-   $\lambda_b$ = baseline lambda (FOI) - the true lambda will be a function of age, therefore we will fit a baseline lambda to obtain estimates of the baseline lambda across the whole population (ages 0 - 60 months)

The modeled relationship between age and enteric NTS infections were compared to the observed distribution of observed eNTS events (NTS PCR and microbiological culture positive stool samples), from the same cross-sectional sample of children.

### Model comparison and diagnostics

Two models were compared; model 1 assumed a constant force of infection (FOI) throughout ages from birth to 60 months, model 2 assumed FOI changed with age in a sigmoidal relationship with age. Both models were fitted to the serological data per age-bin using a Hamiltonian Bayesian Markov-chain Monte-Carlo (HMCMC) approach, using 'brms' r package for model fitting as a Stan interface. Models were compared by Pareto smoothed importance sampling (PSIS) and Widely applicable information criterion (WAIC). Pairwise comparison of models was carried out using Theoretical Expected Log Pointwise predictive Density (ELPD) estimated by (Bayesian) leave-one out (LOO) cross-validation of model 1 and 2 was carried out using the "loo" r package.

```{r echo=FALSE, warning=FALSE, message=FALSE, results='show', ft.align = "left", ft.width = 4.5, out.width = "5in"}
#| tbl-cap: Summary of serological data; Immunoglobulin-gamma to Salmonella Typhimurium used for the serocatalytic model by 3 month age groups.
#| label: tbl-serodatsum
require(tidyverse)
require(ggplot2)
require(cowplot)
require(rio)
require(here)
library(flextable)
library(gt)
library(pacman)
pacman::p_load("ape", "bayesplot", "brms", "broom", "dagitty", "devtools", "flextable", "GGally", "ggdag", "ggdark", "ggmcmc", "ggrepel", "ggthemes", "ggtree", "ghibli", "gtools", 
               "invgamma", "loo", "patchwork", "posterior", "psych", "rcartocolor", "Rcpp", "remotes", "rstan", "santoku", "StanHeaders", "statebins", "tidybayes", "tidyverse", 
               "viridis", "viridisLite", "wesanderson")
p_load(dutchmasters, ggpomological,ggtree,urbnmapr,gganimate)
library(magrittr)
library(dplyr)
library(purrr)
library(forcats)
library(tidyr)
library(modelr)
library(ggdist)
library(tidybayes)
library(ggplot2)
library(cowplot)
library(rstan)
library(brms)
library(ggrepel)
library(RColorBrewer)
library(posterior)
library(distributional)
#remotes::install_github("michael-franke/aida-package")
library(aida)
library(rethinking)


# ##load data
# #data <- import(here("data","6_data", "sero_data_agegroup_mth.csv"))   ## serology data
# Malawi <- import(here("data", "Malawi_STmIgG_master.csv"))
# #rename(EU_all.sero = EU_all.sero)## serology data
# Kenya <- import(here("data", "kenya_STmIgG_master.csv"))   ## serology data
# BF <- import(here("data", "BF_STmIgG_master.csv"))   ## serology data
# sites <- list(Malawi, Kenya, BF)
# names(sites) <- c("Malawi", "Kenya", "BF")
# site_name <- c("Malawi", "Kenya", "BF")
# names(sites)
# 
# model_comp <- function(df, name){ 
#     dataS <- df %>% 
#       mutate(AGEGROUP_mth = cut(age_calc_months, breaks = seq(0,60,1)),
#              AGE = age_calc_months) %>% 
#       group_by(AGEGROUP_mth) %>%
#       summarise(N=n(),
#                 MIDAGE=mean(AGE, na.rm = T), ##keep the actual mean age of the groups
#                 LPS_ME=mean(log(EU_all.sero),na.rm=T),
#                 LPS_SD=sd(log(EU_all.sero),na.rm=T)) %>% 
#       ungroup() %>% 
#       arrange(MIDAGE)
#     
#     data3 <- data %>%
#       group_by(AGEGROUP_3mth) %>%
#       summarise(N=n(),
#                 MIDAGE=mean(AGE, na.rm = T), ##keep the actual mean age of the groups
#                 LPS_ME=mean(log(EU_all.sero),na.rm=T),
#                 LPS_SD=sd(log(EU_all.sero),na.rm=T)) %>%
#       ungroup() %>%
#       arrange(MIDAGE)
#     
#     ## Set fixed parameters
#     dataS$mx=1  # upper limit of new infections (cumulative) by age 60 months = 40 if 1 infection every 6 weeks on average across cohort - may need to adjust for age dist
#     dataS$r=0.2 # exponential phase where enter high feco-oral transmission at weaning/ crawling age  
#     dataS$w=3   # age in months before before enter exponential phase (x-axis displacement) - weaning 
#     dataS$phi0<- max(log(data$EU_all.sero),na.rm=T) ##prior:: the max you may get from the data
#     dataS$beta0<- 0.5 ##pri
#     dataS$lambda0<- 0.11 ##prior
#     
#     # Model 1
#     prior1 <- prior(normal(2.75,0.5), nlpar = "i") +
#       prior(normal(1,0.5), nlpar = "k") +
#       prior(normal(5,1), nlpar = "mab0")
# 
#     # Fit model using brms
#     fit1 <- brms::brm(bf(LPS_ME ~ mab0*exp(-beta0*MIDAGE) + phi0*exp(-i*exp(-k*MIDAGE*lambda0)),
#                          mab0 ~ 1,
#                          i ~ 1,
#                          k ~ 1,
#                          nl = TRUE),
#                       data = dataS, prior = prior1)
# 
#     # Extract fitted dataset + predict model compements using fitted parameters
#     c_eff_midage1 <- as.data.frame(conditional_effects(fit1)$MIDAGE)
#     posteriorSum1 <- tidybayes::tidy_draws(fit1) %>%
#       dplyr::select(starts_with("b_")) %>%
#       pivot_longer(cols = everything()) %>%
#       group_by(name) %>%
#       reframe(aida::summarize_sample_vector(value)[-1])
# 
#     posteriorSum1wide <- posteriorSum1 %>%
#       pivot_wider(names_from = name, values_from = c(2:4))
# 
#     dataSn1 <- bind_cols(dataS, posteriorSum1wide) %>%
#       mutate(mab_MEAN = mean_b_mab0_Intercept*exp(-beta0*MIDAGE),
#              mab_lo = `95%|_b_mab0_Intercept`*exp(-beta0*MIDAGE),
#              mab_hi = `|95%_b_mab0_Intercept`*exp(-beta0*MIDAGE),
#              phi_MEAN = phi0*exp(-mean_b_i_Intercept*exp(-mean_b_k_Intercept*mx*exp(-w*exp(-r*MIDAGE))*lambda0)),
#              phi_lo = phi0*exp(-`95%|_b_i_Intercept`*exp(-`95%|_b_k_Intercept`*mx*exp(-w*exp(-r*MIDAGE))*lambda0)),
#              phi_hi = phi0*exp(-`|95%_b_i_Intercept`*exp(-`|95%_b_k_Intercept`*mx*exp(-w*exp(-r*MIDAGE))*lambda0)),
#              ninf_MEAN = mx*exp(-w*exp(-r*MIDAGE))*lambda0,
#              ninf_lo = mx*exp(-w*exp(-r*MIDAGE))*lambda0,
#              ninf_hi = mx*exp(-w*exp(-r*MIDAGE))*lambda0)
# 
#     ### Model 2
#     prior2 <- prior(normal(1.46, 0.05), nlpar = "i") + # Priors = posteriors from linear model HMCMC
#       prior(normal(4,0.5), nlpar = "k") +
#       prior(normal(3,0.54), nlpar = "mab0")+
#       prior(normal(0.2,0.1), nlpar = "r") +
#       prior(normal(2,0.5), nlpar = "E") +
#       prior(normal(0.15,0.02), nlpar = "lambdaB")
# 
#     fit2 <- brms::brm(bf(LPS_ME ~ mab0*exp(-beta0*MIDAGE) + phi0*exp(-i*exp(-k*mx*exp(-w*exp(-r*MIDAGE))*lambdaB))-E,
#                          mab0 ~ 1,
#                          r ~ 1,
#                          i ~ 1,
#                          k ~ 1,
#                          E ~ 1,
#                          lambdaB ~ 1,
#                          nl = TRUE),
#                       data = dataS, prior = prior2)
#     c_eff_midage2 <- as.data.frame(conditional_effects(fit2)$MIDAGE)
#     posteriorSum2 <- tidybayes::tidy_draws(fit2) %>%
#       dplyr::select(starts_with("b_")) %>%
#       pivot_longer(cols = everything()) %>%
#       group_by(name) %>%
#       reframe(aida::summarize_sample_vector(value)[-1])
# 
#     posteriorSum2wide <- posteriorSum2 %>%
#       pivot_wider(names_from = name, values_from = c(2:4))
# 
#     dataSn2 <- bind_cols(dataS, posteriorSum2wide) %>%
#       mutate(mab_MEAN = mean_b_mab0_Intercept*exp(-beta0*MIDAGE),
#              mab_lo = `95%|_b_mab0_Intercept`*exp(-beta0*MIDAGE),
#              mab_hi = `|95%_b_mab0_Intercept`*exp(-beta0*MIDAGE),
#              phi_MEAN = phi0*exp(-mean_b_i_Intercept*exp(-mean_b_k_Intercept*mx*exp(-w*exp(-r*MIDAGE))*mean_b_lambdaB_Intercept))-mean_b_E_Intercept,
#              phi_lo = phi0*exp(-`95%|_b_i_Intercept`*exp(-`95%|_b_k_Intercept`*mx*exp(-w*exp(-r*MIDAGE))*`95%|_b_lambdaB_Intercept`))-`95%|_b_E_Intercept`,
#              phi_hi = phi0*exp(-`|95%_b_i_Intercept`*exp(-`|95%_b_k_Intercept`*mx*exp(-w*exp(-r*MIDAGE))*`|95%_b_lambdaB_Intercept`))-`|95%_b_E_Intercept`,
#              ninf_MEAN = mx*exp(-w*exp(-r*MIDAGE))*mean_b_lambdaB_Intercept,
#              ninf_lo = mx*exp(-w*exp(-r*MIDAGE))*`95%|_b_lambdaB_Intercept`,
#              ninf_hi = mx*exp(-w*exp(-r*MIDAGE))*`|95%_b_lambdaB_Intercept`)
# 
#     fit1 <- add_criterion(fit1, "waic")
#     fit2 <- add_criterion(fit2, "waic")
# 
#     # compare both models
#     loo_tab <- as.data.frame(round(loo_compare(fit1, fit2, criterion = "waic"),digits=2)) %>%
#       rownames_to_column()
#     loo_tabft <- loo_tab %>% flextable()
#     print(loo_tabft)
#     
#     export(dataS, here("data", "6_data", paste0(sep="",name,"dataS.csv")))
#     export(fit1, here("data", "6_data", paste0(sep="",name,"fit1.RData")))
#     export(fit2, here("data", "6_data", paste0(sep="",name,"fit2.RData")))
#     export(c_eff_midage1, here("data", "6_data", paste0(sep="",name,"c_eff_midage1.csv")))
#     export(c_eff_midage2, here("data", "6_data", paste0(sep="",name,"c_eff_midage2.csv")))
#     export(dataSn1, here("data", "6_data", paste0(sep="",name,"dataSn1.csv")))
#     export(dataSn2, here("data", "6_data", paste0(sep="",name,"dataSn2.csv")))
#     export(loo_tab, here("data", "6_data", paste0(sep="",name,"loo_tab.csv")))
# 
# }
# lapply(names(sites), function(name) model_comp(sites[[name]], name))


gg_fit_func <- function(dataS, c_eff_midage){
  g <- ggplot() +
  geom_ribbon(aes(x=MIDAGE, ymin=exp(LPS_ME-LPS_SD), ymax=exp(LPS_ME+LPS_SD)), alpha=0.3, fill="red",data=dataS) +
  geom_ribbon(aes(x=MIDAGE, ymin=exp(lower__), ymax=exp(upper__)), alpha=0.3, fill='blue', data=c_eff_midage) +
  #geom_point(aes(x=MIDAGE, y=estimate__),fill="blue", data=c_eff_midage) +
  geom_point(aes(x=MIDAGE, y=exp(LPS_ME)),colour="blue", data=dataS) +
  theme_bw() +
  xlab("Age (months)") +
  ylab("Anti-STm IgG (EU/ml)") +
 # coord_cartesian(ylim = c(0,1000))+
  scale_y_log10(labels = prettyNum) +
  ggtitle("IgG GMC model fit vs data") +
  scale_x_continuous(breaks = c(seq(0,60,5))) +
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=10,face="bold"),
        plot.title = element_text(size=10))
}

gg_ninffuncum <- function(dataSn){
  gg_cum_ninf<- ggplot(dataSn) +
    geom_ribbon(aes(x=MIDAGE, ymin=ninf_lo*MIDAGE, ymax=ninf_hi*MIDAGE), alpha=0.3, fill="goldenrod") +
    geom_point(aes(x=MIDAGE, y=ninf_MEAN*MIDAGE), colour="goldenrod3") +
    theme_bw() +
    xlab("Mid-age in months") +
    ylab("Number of infections") +
    ggtitle("Number of infections by age") +
    scale_x_continuous(breaks = c(seq(0,60,5))) +
    theme(axis.text=element_text(size=6),
          axis.title=element_text(size=10,face="bold"),
          plot.title = element_text(size=10))
}

gg_ninffunc <- function(dataSn){
  gg_ninf<- ggplot(dataSn) +
    geom_ribbon(aes(x=MIDAGE, ymin=ninf_lo, ymax=ninf_hi), alpha=0.3, fill="goldenrod") +
    geom_point(aes(x=MIDAGE, y=ninf_MEAN), colour="goldenrod3") +
    theme_bw() +
    xlab("Mid-age in months") +
    ylab("Number of infections") +
    ggtitle("Percentage of children with eNTS in each age group") +
    scale_x_continuous(breaks = c(seq(0,60,5))) +
    theme(axis.text=element_text(size=6),
          axis.title=element_text(size=10,face="bold"),
          plot.title = element_text(size=10))
}

gg_mab_phi_fun<- function(dataSn){
  gg_mab_phi<- ggplot(dataSn) +
    geom_ribbon(aes(x=MIDAGE, ymin=exp(mab_lo), ymax=exp(mab_hi)), col='pink', alpha=0.3) +
    geom_point(aes(x=MIDAGE, y=exp(mab_MEAN)), col='pink') +
    geom_ribbon(aes(x=MIDAGE, ymin=exp(phi_lo), ymax=exp(phi_hi)), col='gold', alpha=0.3) +
    geom_point(aes(x=MIDAGE, y=exp(phi_MEAN)), col='gold') +
    theme_bw() +
    xlab("Mid-age in months") +
    ylab("Anti-STm IgG (EU/ml)") +
    scale_y_log10(labels = prettyNum) +
    ggtitle("Mab and Theta (Î¸) by age") +
    scale_x_continuous(breaks = c(seq(0,60,5))) +
    theme(axis.text=element_text(size=6),
          axis.title=element_text(size=10,face="bold"),
          plot.title = element_text(size=10))
}

no <- c("1", "2")
co <- c("Malawi", "Kenya", "BF")
modelLs <- list()
plotLs <- list()
plotLsninf <- list()
plotLsninfcum <- list()
plotLsmabphi <- list()

for(n in no){
  for(c in co){
    modelLs[[c]]$dataS <- import(here("data", "6_data", paste(sep="",c,"dataS.csv")))#
    modelLs[[n]][[c]]$fit <- import_list(here("data", "6_data", paste(sep="",c,"fit",n,".RData")))#
    modelLs[[n]][[c]]$c_eff_midage <- import(here("data", "6_data", paste(sep="",c,"c_eff_midage",n,".csv")))#
    modelLs[[n]][[c]]$dataSn <- import(here("data", "6_data", paste(sep="",c,"dataSn",n,".csv")))#
    plotLs[[n]][[c]] <- gg_fit_func(modelLs[[c]]$dataS, modelLs[[n]][[c]]$c_eff_midage)
    plotLsninf[[n]][[c]] <- gg_ninffunc(modelLs[[n]][[c]]$dataSn)
    plotLsninfcum[[n]][[c]] <- gg_ninffuncum(modelLs[[n]][[c]]$dataSn)
    plotLsmabphi[[n]][[c]] <- gg_mab_phi_fun(modelLs[[n]][[c]]$dataSn)
  }
}
##load data
#data <- import(here("data","6_data", "sero_data_agegroup_mth.csv"))   ## serology data
data <- import(here("data","6_data", "Malawi_STmIgG_master.csv")) %>%
  mutate(AGEGROUP_mth = cut(age_calc_months, breaks = seq(0,60,1)),
         AGE = age_calc_months) %>% 
  filter(AGE<=60)

data3 <- data %>% 
  group_by(AGEGROUP_3mth) %>%
  summarise(N=n(),
            MIDAGE=mean(AGE, na.rm = T), ##keep the actual mean age of the groups
            LPS_ME=exp(mean(log(EU_all.sero),na.rm=T)),
            LPS_SD=exp(sd(log(EU_all.sero),na.rm=T))) %>% 
  ungroup() %>% 
  arrange(MIDAGE)

flextable(data3) %>% 
  fontsize(i = 1, size = 8, part = "header") %>%   # adjust font size of header
  bold(i = 1, bold = TRUE, part = "header") %>%    # adjust bold face of header
  fontsize(size = 8, part = "body") %>%  # adjust font size of header
  fontsize(size = 4, part = "footer") %>%  # adjust font size of header
  set_header_labels(         # Rename the columns in original header row
    AGEGROUP_3mth = "Age Group (months)",
    N = "Number",
    MIDAGE = "Mean Age (months)",
    LPS_ME = "GMC anti-STm IgG (EU/ml)",
    LPS_SD = "SD anti-STm IgG (EU/ml)"
  ) %>% 
  autofit() %>% 
  footnote(i=1, j=4:5,
           value = as_paragraph(
             c(
               "Geometric Mean Concentration (GMC) of immunoglobulin-gamma (IgG) to S. typhimurium (STm)",
               "Standard Deviation (SD) of GMC"
             )
           ),
           ref_symbols = c("a", "b"),
           part = "header")
total <- data %>% 
  summarise(n())

####################################################
theme_set(
  theme_base(base_size = 12) +
    theme(text = element_text(family = "Times"),
          axis.text = element_text(family = "Times"),
          axis.ticks = element_line(linewidth = 0.25),
          axis.ticks.length = unit(0.1, "cm"),
          panel.background = element_rect(linewidth = 0.1),
          plot.background = element_blank(),
    )
)
# Summary of posterior distributions
dataS <- modelLs$Malawi$dataS
dataSn1 <- modelLs$`1`$Malawi$dataSn
dataSn2 <- modelLs$`2`$Malawi$dataSn
c_eff_midage1 <- modelLs$`1`$Malawi$c_eff_midage
c_eff_midage2 <- modelLs$`2`$Malawi$c_eff_midage
fit1 <- modelLs$`1`$Malawi$fit
fit2 <- modelLs$`2`$Malawi$fit
## sites
dataSnKen2 <- modelLs$`2`$Kenya$dataSn
dataSnBF2 <- modelLs$`2`$BF$dataSn

malawi_tab <- dataSn2 %>% select(c(contains("Intercept"))) %>% slice_head(n=1) %>% mutate(Country="Malawi")
ken_tab <- dataSnKen2 %>% select(c(contains("Intercept"))) %>% slice_head(n=1) %>% mutate(Country="Kenya")
BF_tab <- dataSnBF2 %>% select(c(contains("Intercept"))) %>% slice_head(n=1) %>% mutate(Country="Burkina Faso")
sites_tab <- bind_rows(malawi_tab, ken_tab, BF_tab) %>% 
  mutate(across(where(is.numeric), round, 2)) %>% 
  mutate("i" = paste0(sep="",mean_b_i_Intercept," (",`|95%_b_i_Intercept`,"-",`95%|_b_i_Intercept`,")"),
         "k" = paste0(sep="",mean_b_k_Intercept," (",`|95%_b_k_Intercept`,"-",`95%|_b_k_Intercept`,")"),
         "r" = paste0(sep="",mean_b_r_Intercept," (",`|95%_b_r_Intercept`,"-",`95%|_b_r_Intercept`,")"),
         "mab" = paste0(sep="",mean_b_mab0_Intercept," (",`|95%_b_mab0_Intercept`,"-",`95%|_b_mab0_Intercept`,")"),
         "lambdaB" = paste0(sep="",mean_b_lambdaB_Intercept," (",`|95%_b_lambdaB_Intercept`,"-",`95%|_b_lambdaB_Intercept`,")"),
         "E" = paste0(sep="",mean_b_E_Intercept," (",`|95%_b_E_Intercept`,"-",`95%|_b_E_Intercept`,")")) %>% 
  select(c(Country, mab, i, k, r, lambdaB, E))

malawi_ninf <- dataSn2 %>% filter(AGEGROUP_mth=="(0,1]"| AGEGROUP_mth=="(6,7]"| AGEGROUP_mth=="(12,13]"|AGEGROUP_mth=="(24,25]"|AGEGROUP_mth=="(59,60]") %>% mutate(Country="Malawi")
ken_ninf <- dataSnKen2 %>% filter(AGEGROUP_mth=="(0,1]"| AGEGROUP_mth=="(6,7]"| AGEGROUP_mth=="(12,13]"|AGEGROUP_mth=="(24,25]"|AGEGROUP_mth=="(59,60]") %>% mutate(Country="Kenya")
BF_ninf <- dataSnBF2 %>% filter(AGEGROUP_mth=="(0,1]"| AGEGROUP_mth=="(6,7]"| AGEGROUP_mth=="(12,13]"|AGEGROUP_mth=="(24,25]"|AGEGROUP_mth=="(59,60]") %>% mutate(Country="Burkina Faso")
ninf_all <- bind_rows(malawi_ninf, ken_ninf, BF_ninf)
ninf_all2 <- ninf_all %>% 
  mutate(
    cum_ninf_mean = ninf_MEAN*MIDAGE,
    cum_ninf_lo = ninf_lo*MIDAGE,
    cum_ninf_hi = ninf_hi*MIDAGE) %>% 
  mutate(across(where(is.numeric), round, 2)) %>% 
  mutate(
    ninf = paste0(sep="", ninf_MEAN, " (",ninf_lo,"-",ninf_hi,")"),
    cum_ninf = paste0(sep="", cum_ninf_mean, " (",cum_ninf_lo,"-",cum_ninf_hi,")")) %>% 
  select(Country, AGEGROUP_mth, ninf, cum_ninf) 

#sites_tab2 <- sites_tab %>% left_join(ninf_all2)
      
## malawi
i_mean1 <- round(dataSn1$mean_b_i_Intercept, digits=2)[1] 
i_95CI1 <- paste0(sep="","(", round(dataSn1$`95%|_b_i_Intercept`,digits=2)," - ", round(dataSn1$`|95%_b_i_Intercept`,digits=2),")")[1]
k_mean1 <- round(dataSn1$mean_b_k_Intercept, digits=2)[1]
k_95CI1 <-  paste0(sep="","(", round(dataSn1$`95%|_b_k_Intercept`,digits=2)," - ", round(dataSn1$`|95%_b_k_Intercept`,digits=2),")")[1]
mab_mean1 <- round(dataSn1$mean_b_mab0_Intercept, digits=2)[1]
mab_95CI1 <-paste0(sep="","(", round(dataSn1$`95%|_b_mab0_Intercept`,digits=2)," - ", round(dataSn1$`|95%_b_mab0_Intercept`,digits=2),")")[1]
ninf0_1 <- dataSn1 %>% filter(AGEGROUP_mth=="(0,1]")
ninf06_1 <- dataSn1 %>% filter(AGEGROUP_mth=="(6,7]")
ninf12_1 <- dataSn1 %>% filter(AGEGROUP_mth=="(12,13]")
ninf24_1 <- dataSn1 %>% filter(AGEGROUP_mth=="(24,25]")
ninf60_1 <- dataSn1 %>% filter(AGEGROUP_mth=="(59,60]")

i_mean2 <- round(dataSn2$mean_b_i_Intercept, digits=2)[1]
i_95CI2 <- paste0(sep="","(", round(dataSn2$`95%|_b_i_Intercept`,digits=2)," - ", round(dataSn2$`|95%_b_i_Intercept`,digits=2),")")[1]
k_mean2 <- round(dataSn2$mean_b_k_Intercept, digits=2)[1]
k_95CI2 <-  paste0(sep="","(", round(dataSn2$`95%|_b_k_Intercept`,digits=2)," - ", round(dataSn2$`|95%_b_k_Intercept`,digits=2),")")[1]
mab_mean2 <- round(dataSn2$mean_b_mab0_Intercept, digits=2)[1]
mab_95CI2 <-paste0(sep="","(", round(dataSn2$`95%|_b_mab0_Intercept`,digits=2)," - ", round(dataSn2$`|95%_b_mab0_Intercept`,digits=2),")")[1]
r_mean2 <- round(dataSn2$mean_b_r_Intercept, digits=2)[1]
r_95CI2 <-paste0(sep="","(", round(dataSn2$`95%|_b_r_Intercept`,digits=2)," - ", round(dataSn2$`|95%_b_r_Intercept`,digits=2),")")[1]
lambdaB_mean2 <- round(dataSn2$mean_b_lambdaB_Intercept, digits=2)[1]
lambdaB_95CI2 <-paste0(sep="","(", round(dataSn2$`95%|_b_lambdaB_Intercept`,digits=2)," - ", round(dataSn2$`|95%_b_lambdaB_Intercept`,digits=2),")")[1]
ninf0_2 <- dataSn2 %>% filter(AGEGROUP_mth=="(0,1]")
ninf06_2 <- dataSn2 %>% filter(AGEGROUP_mth=="(6,7]")
ninf12_2 <- dataSn2 %>% filter(AGEGROUP_mth=="(12,13]")
ninf24_2 <- dataSn2 %>% filter(AGEGROUP_mth=="(24,25]")
ninf60_2 <- dataSn2 %>% filter(AGEGROUP_mth=="(59,60]")

## Sites
ninf0_Ken2 <- dataSnKen2 %>% filter(AGEGROUP_mth=="(0,1]")
ninf06_Ken2 <- dataSnKen2 %>% filter(AGEGROUP_mth=="(6,7]")
ninf12_Ken2 <- dataSnKen2 %>% filter(AGEGROUP_mth=="(12,13]")
ninf24_Ken2 <- dataSnKen2 %>% filter(AGEGROUP_mth=="(24,25]")
ninf60_Ken2 <- dataSnKen2 %>% filter(AGEGROUP_mth=="(59,60]")
i_mean2K <- round(dataSnKen2$mean_b_i_Intercept, digits=2)[1]
i_95CI2K <- paste0(sep="","(", round(dataSnKen2$`95%|_b_i_Intercept`,digits=2)," - ", round(dataSnKen2$`|95%_b_i_Intercept`,digits=2),")")[1]
k_mean2K <- round(dataSnKen2$mean_b_k_Intercept, digits=2)[1]
k_95CI2K <-  paste0(sep="","(", round(dataSnKen2$`95%|_b_k_Intercept`,digits=2)," - ", round(dataSnKen2$`|95%_b_k_Intercept`,digits=2),")")[1]
mab_mean2K <- round(dataSnKen2$mean_b_mab0_Intercept, digits=2)[1]
mab_95CI2K <-paste0(sep="","(", round(dataSnKen2$`95%|_b_mab0_Intercept`,digits=2)," - ", round(dataSnKen2$`|95%_b_mab0_Intercept`,digits=2),")")[1]
r_mean2K <- round(dataSnKen2$mean_b_r_Intercept, digits=2)[1]
r_95CI2K <-paste0(sep="","(", round(dataSnKen2$`95%|_b_r_Intercept`,digits=2)," - ", round(dataSnKen2$`|95%_b_r_Intercept`,digits=2),")")[1]
lambdaB_mean2K <- round(dataSnKen2$mean_b_lambdaB_Intercept, digits=2)[1]
lambdaB_95CI2K <-paste0(sep="","(", round(dataSnKen2$`95%|_b_lambdaB_Intercept`,digits=2)," - ", round(dataSnKen2$`|95%_b_lambdaB_Intercept`,digits=2),")")[1]

ninf0_BF2 <- dataSnBF2 %>% filter(AGEGROUP_mth=="(0,1]")
ninf06_BF2 <- dataSnBF2 %>% filter(AGEGROUP_mth=="(6,7]")
ninf12_BF2 <- dataSnBF2 %>% filter(AGEGROUP_mth=="(12,13]")
ninf24_BF2 <- dataSnBF2 %>% filter(AGEGROUP_mth=="(24,25]")
ninf60_BF2 <- dataSnBF2 %>% filter(AGEGROUP_mth=="(59,60]")
i_mean2B <- round(dataSnBF2$mean_b_i_Intercept, digits=2)[1]
i_95CI2B <- paste0(sep="","(", round(dataSnBF2$`95%|_b_i_Intercept`,digits=2)," - ", round(dataSnBF2$`|95%_b_i_Intercept`,digits=2),")")[1]
k_mean2B <- round(dataSnBF2$mean_b_k_Intercept, digits=2)[1]
k_95CI2B <-  paste0(sep="","(", round(dataSnBF2$`95%|_b_k_Intercept`,digits=2)," - ", round(dataSnBF2$`|95%_b_k_Intercept`,digits=2),")")[1]
mab_mean2B <- round(dataSnBF2$mean_b_mab0_Intercept, digits=2)[1]
mab_95CI2B <-paste0(sep="","(", round(dataSnBF2$`95%|_b_mab0_Intercept`,digits=2)," - ", round(dataSnBF2$`|95%_b_mab0_Intercept`,digits=2),")")[1]
r_mean2B <- round(dataSnBF2$mean_b_r_Intercept, digits=2)[1]
r_95CI2B <-paste0(sep="","(", round(dataSnBF2$`95%|_b_r_Intercept`,digits=2)," - ", round(dataSnBF2$`|95%_b_r_Intercept`,digits=2),")")[1]
lambdaB_mean2B <- round(dataSnBF2$mean_b_lambdaB_Intercept, digits=2)[1]
lambdaB_95CI2B <-paste0(sep="","(", round(dataSnBF2$`95%|_b_lambdaB_Intercept`,digits=2)," - ", round(dataSnBF2$`|95%_b_lambdaB_Intercept`,digits=2),")")[1]

#### loo
loo_all <- import(here("data", "6_data","loo_all.csv"))
loo_malawi1 <- loo_all %>% filter(Country=="Malawi" & rowname=="fit1")
loo_malawi2 <- loo_all %>% filter(Country=="Malawi" & rowname=="fit2")
loo_BF <- loo_all %>% filter(Country=="Burkina Faso")
loo_kenya <- loo_all %>% filter(Country=="Kenya")
```

## Results

### Descriptive analysis

Cross-sectional samples were analysed for `{r} total` Malawian children 0-60 months recruited in the SAiNTS study, recruited between 9th January 2021 and 30th May 2022. Antibody responses to *Salmonella* typhimurium (STm) O-antigen IgG were used to fit the model. The geometric mean concentration (GMC) of STm OAg IgG for each 3 month age group is shown in @tbl-serodatsum. The model was fitted to GMC for 1 month age groups (0 - 60 months), allowing the model to find the values of i, k and mab that best fit the observed data. The priors for i, k, mab were based on informative priors estimated from previous data [@nyirenda_sequential_2014].

### Model 1: Constant force of infection

Model fitting to the observed antibody data is shown in @fig-fit1. The posterior chains are shown in @fig-posteriors1. The posterior distributions were i, k and mab are shown in @fig-posteriors1; the mean for the posterior distribution of i was `{r} i_mean1`, with 95% credible intervals (CI) `{r} i_95CI1`, the mean for k was `{r} k_mean1` & 95% CI `{r} k_95CI1`, and the mean for mab was `{r} mab_mean1` with 95% CI `{r} mab_95CI1`. The model fit for the individual model components mab (maternal antibody decay) and phi (acquisition of natural immunity following eNTS exposure) are shown in @fig-fit1. Model 1 estimated that the proportion of children who had a salmonella infection inducing serotype-specific IgG response at age 0 was `{r} print(round(ninf0_1$ninf_MEAN,digits = 2))`, rising to `{r} print(round(ninf06_1$ninf_MEAN,digits = 2))` at 6 months, `{r} print(round(ninf12_1$ninf_MEAN,digits = 2))` at 12 months, `{r} print(round(ninf24_1$ninf_MEAN,digits = 2))` at 24 months, and `{r} print(round(ninf60_1$ninf_MEAN,digits = 2))` at 60 months. This corresponds to estimated `{r} print(round(ninf0_1$ninf_MEAN*ninf0_1$MIDAGE,digits = 2))` , `{r} print(round(ninf06_1$ninf_MEAN*ninf06_1$MIDAGE,digits = 2))`, `{r} print(round(ninf12_1$ninf_MEAN*ninf12_1$MIDAGE,digits = 2))`, `{r} print(round(ninf24_1$ninf_MEAN*ninf24_1$MIDAGE,digits = 2))` and `{r} print(round(ninf60_1$ninf_MEAN*ninf60_1$MIDAGE,digits = 2))` cumulative salmonella infections inducing *S*. typhimurium specific IgG response at age 0, 6, 12, 24 and 60 months respectively.

### Model 2: Changing force of infection with age

The posterior distributions were i, k and mab are shown in @fig-posteriors2; the mean for i was `{r} i_mean2`, with 95% credible intervals (CI) `{r} i_95CI2`, the mean for k was `{r} k_mean2` 95% CI `{r} k_95CI2`, and the mean for mab was `{r} mab_mean2` 95% CI `{r} mab_95CI2`. The posterior means for the two additional parameters were lambdaB mean `{r} lambdaB_mean2` 95% CI `{r} lambdaB_95CI2`, and r mean was`{r} r_mean2` 95% CI `{r} r_95CI2`. The model fit for the individual model components mab (maternal antibody decay) and phi (acquisition of natural immunity following eNTS exposure) are shown in @fig-fit2. Model 2 estimated that the proportion of children who had a salmonella infection inducing serotype-specific IgG response in the first month of life was `{r} print(round(ninf0_2$ninf_MEAN,digits = 2))` (95% CI; `{r} print(round(ninf0_2$ninf_lo,digits = 2))` - `{r} print(round(ninf0_2$ninf_hi,digits = 2))`), rising to `{r} print(round(ninf06_2$ninf_MEAN,digits = 2))` (95% CI; `{r} print(round(ninf06_2$ninf_lo,digits = 2))` - `{r} print(round(ninf06_2$ninf_hi,digits = 2))`) at age 6-7 months, `{r} print(round(ninf12_2$ninf_MEAN,digits = 2))` (95% CI; `{r} print(round(ninf12_2$ninf_lo,digits = 2))` - `{r} print(round(ninf12_2$ninf_hi,digits = 2))`) at age 12-13 months, `{r} print(round(ninf24_2$ninf_MEAN,digits = 2))` (95% CI; `{r} print(round(ninf24_2$ninf_lo,digits = 2))` - `{r} print(round(ninf24_2$ninf_hi,digits = 2))`), at age 24-25 months, and `{r} print(round(ninf60_2$ninf_MEAN,digits = 2))` (95% CI; `{r} print(round(ninf60_2$ninf_lo,digits = 2))` - `{r} print(round(ninf60_2$ninf_hi,digits = 2))`) at 59-60 months. This corresponds to estimated `{r} print(round(ninf0_2$ninf_MEAN*ninf0_2$MIDAGE,digits = 2))` (95% CI; `{r} print(round(ninf0_2$ninf_lo*ninf0_2$MIDAGE,digits = 2))` - `{r} print(round(ninf0_2$ninf_hi*ninf0_2$MIDAGE,digits = 2))`), `{r} print(round(ninf06_2$ninf_MEAN*ninf06_2$MIDAGE,digits = 2))` (95% CI; `{r} print(round(ninf06_2$ninf_lo*ninf06_2$MIDAGE,digits = 2))` - `{r} print(round(ninf06_2$ninf_hi*ninf06_2$MIDAGE,digits = 2))`), `{r} print(round(ninf12_2$ninf_MEAN*ninf12_2$MIDAGE,digits = 2))` (95% CI; `{r} print(round(ninf12_2$ninf_lo*ninf12_2$MIDAGE,digits = 2))` - `{r} print(round(ninf12_2$ninf_hi*ninf12_2$MIDAGE,digits = 2))`), `{r} print(round(ninf24_2$ninf_MEAN*ninf24_2$MIDAGE,digits = 2))` (95% CI; `{r} print(round(ninf24_2$ninf_lo*ninf24_2$MIDAGE,digits = 2))` - `{r} print(round(ninf24_2$ninf_hi*ninf24_2$MIDAGE,digits = 2))`) and `{r} print(round(ninf60_2$ninf_MEAN*ninf60_2$MIDAGE,digits = 2))` (95% CI; `{r} print(round(ninf60_2$ninf_lo*ninf60_2$MIDAGE,digits = 2))` - `{r} print(round(ninf60_2$ninf_hi*ninf60_2$MIDAGE,digits = 2))`) cumulative salmonella infections inducing *S*. typhimurium-specific IgG response by age 0, 6, 12, 24 and 60 months respectively.

### Model comparison

Model 2 was selected as the best fit model; model 1 had an ELPD difference of `{r} print(loo_malawi1$elpd_diff)` (SE: `{r} print(loo_malawi1$se_diff)`) relative to model 2, with a WAIC of `{r} print(loo_malawi1$waic)` `{r} print(loo_malawi1$se_waic)` compared to model 2 which had a WAIC of `{r} print(loo_malawi2$waic)` (SE`{r} print(loo_malawi2$se_waic)`) (@tbl-sites).

## Models for other sites

Both model 1 and 2 were run for each of the other VacciNTS sites; Burkina Faso and Kenya, model comparisons are shown in @tbl-sites. Model 2 was selected as best fit across all sites. The posterior distributions for Kenya were i mean `{r} i_mean2K` 95% CI `{r} i_95CI2K`, the mean for k was `{r} k_mean2K` 95% CI `{r} k_95CI2K`, mean for mab was `{r} mab_mean2K` 95% CI `{r} mab_95CI2K`, lambdaB mean was `{r} lambdaB_mean2K`95% CI `{r} lambdaB_95CI2K`, and r mean was `{r} r_mean2K` 95% CI `{r} r_95CI2K`. The posterior distributions for Burkina Faso were i mean `{r} i_mean2B` 95% CI `{r} i_95CI2B`, the mean for k was `{r} k_mean2B` 95% CI `{r} k_95CI2B`, mean for mab was `{r} mab_mean2B` 95% CI `{r} mab_95CI2B`, lambdaB mean was `{r} lambdaB_mean2B` 95% CI `{r} lambdaB_95CI2B`, and r mean was `{r} r_mean2K` 95% CI `{r} r_95CI2B`.

In Kenya, model 2 estimated that the proportion of children who had a salmonella infection inducing *S*. typhimurium-specific IgG response in the first month of life was `{r} print(round(ninf0_Ken2$ninf_MEAN,digits = 2))` (95% CI; `{r} print(round(ninf0_Ken2$ninf_lo,digits = 2))` - `{r} print(round(ninf0_Ken2$ninf_hi,digits = 2))`), rising to `{r} print(round(ninf06_Ken2$ninf_MEAN,digits = 2))` (95% CI; `{r} print(round(ninf06_Ken2$ninf_lo,digits = 2))` - `{r} print(round(ninf06_Ken2$ninf_hi,digits = 2))`) at age 6-7 months, `{r} print(round(ninf12_Ken2$ninf_MEAN,digits = 2))` (95% CI; `{r} print(round(ninf12_Ken2$ninf_lo,digits = 2))` - `{r} print(round(ninf12_Ken2$ninf_hi,digits = 2))`) at age 12-13 months, `{r} print(round(ninf24_Ken2$ninf_MEAN,digits = 2))` (95% CI; `{r} print(round(ninf24_Ken2$ninf_lo,digits = 2))` - `{r} print(round(ninf24_Ken2$ninf_hi,digits = 2))`) at age 24-25 months, and `{r} print(round(ninf60_Ken2$ninf_MEAN,digits = 2))` (95% CI; `{r} print(round(ninf60_Ken2$ninf_lo,digits = 2))` - `{r} print(round(ninf60_Ken2$ninf_hi,digits = 2))`) in months 59 -60. This corresponds to estimated `{r} print(round(ninf0_Ken2$ninf_MEAN*ninf0_Ken2$MIDAGE,digits = 2))` (95% CI; `{r} print(round(ninf0_Ken2$ninf_lo*ninf0_Ken2$MIDAGE,digits = 2))` - `{r} print(round(ninf0_Ken2$ninf_hi*ninf0_Ken2$MIDAGE,digits = 2))`), `{r} print(round(ninf06_Ken2$ninf_MEAN*ninf06_Ken2$MIDAGE,digits = 2))` (95% CI; `{r} print(round(ninf06_Ken2$ninf_lo*ninf06_Ken2$MIDAGE,digits = 2))` - `{r} print(round(ninf06_Ken2$ninf_hi*ninf06_Ken2$MIDAGE,digits = 2))`), `{r} print(round(ninf12_Ken2$ninf_MEAN*ninf12_Ken2$MIDAGE,digits = 2))` (95% CI; `{r} print(round(ninf12_Ken2$ninf_lo*ninf12_Ken2$MIDAGE,digits = 2))` - `{r} print(round(ninf12_Ken2$ninf_hi*ninf12_Ken2$MIDAGE,digits = 2))`), `{r} print(round(ninf24_Ken2$ninf_MEAN*ninf24_Ken2$MIDAGE,digits = 2))` (95% CI; `{r} print(round(ninf24_Ken2$ninf_lo*ninf24_Ken2$MIDAGE,digits = 2))` - `{r} print(round(ninf24_Ken2$ninf_hi*ninf24_Ken2$MIDAGE,digits = 2))`) and `{r} print(round(ninf60_Ken2$ninf_MEAN*ninf60_Ken2$MIDAGE,digits = 2))` (95% CI; `{r} print(round(ninf60_Ken2$ninf_lo*ninf60_Ken2$MIDAGE,digits = 2))` - `{r} print(round(ninf60_Ken2$ninf_hi*ninf60_Ken2$MIDAGE,digits = 2))`) cumulative salmonella infections inducing serotype-specific IgG response the age 0, 6, 12, 24 and 60 months respectively. In Burkina Faso, model 2 estimated that the proportion of children who had a salmonella infection inducing serotype-specific IgG response in the first month of life was `{r} print(round(ninf0_BF2$ninf_MEAN,digits = 2))` (95% CI; `{r} print(round(ninf0_BF2$ninf_lo,digits = 2))` - `{r} print(round(ninf0_BF2$ninf_hi,digits = 2))`), rising to `{r} print(round(ninf06_BF2$ninf_MEAN,digits = 2))` (95% CI; `{r} print(round(ninf06_BF2$ninf_lo,digits = 2))` - `{r} print(round(ninf06_BF2$ninf_hi,digits = 2))`) in months 6-7, `{r} print(round(ninf12_BF2$ninf_MEAN,digits = 2))` (95% CI; `{r} print(round(ninf12_BF2$ninf_lo,digits = 2))` - `{r} print(round(ninf12_BF2$ninf_hi,digits = 2))`) in months 12-13, `{r} print(round(ninf24_BF2$ninf_MEAN,digits = 2))` (95% CI; `{r} print(round(ninf24_BF2$ninf_lo,digits = 2))` - `{r} print(round(ninf24_BF2$ninf_hi,digits = 2))`) in months 24-25, and `{r} print(round(ninf60_BF2$ninf_MEAN,digits = 2))` (95% CI; `{r} print(round(ninf60_BF2$ninf_lo,digits = 2))` - `{r} print(round(ninf60_BF2$ninf_hi,digits = 2))`) in months 59 -60. This corresponds to estimated `{r} print(round(ninf0_BF2$ninf_MEAN*ninf0_BF2$MIDAGE,digits = 2))` (95% CI; `{r} print(round(ninf0_BF2$ninf_lo*ninf0_BF2$MIDAGE,digits = 2))` - `{r} print(round(ninf0_BF2$ninf_hi*ninf0_BF2$MIDAGE,digits = 2))`), `{r} print(round(ninf06_BF2$ninf_MEAN*ninf06_BF2$MIDAGE,digits = 2))` (95% CI; `{r} print(round(ninf06_BF2$ninf_lo*ninf06_BF2$MIDAGE,digits = 2))` - `{r} print(round(ninf06_BF2$ninf_hi*ninf06_BF2$MIDAGE,digits = 2))`), `{r} print(round(ninf12_BF2$ninf_MEAN*ninf12_BF2$MIDAGE,digits = 2))` (95% CI; `{r} print(round(ninf12_BF2$ninf_lo*ninf12_BF2$MIDAGE,digits = 2))` - `{r} print(round(ninf12_BF2$ninf_hi*ninf12_BF2$MIDAGE,digits = 2))`), `{r} print(round(ninf24_BF2$ninf_MEAN*ninf24_BF2$MIDAGE,digits = 2))` (95% CI; `{r} print(round(ninf24_BF2$ninf_lo*ninf24_BF2$MIDAGE,digits = 2))` - `{r} print(round(ninf24_BF2$ninf_hi*ninf24_BF2$MIDAGE,digits = 2))`) and `{r} print(round(ninf60_BF2$ninf_MEAN*ninf60_BF2$MIDAGE,digits = 2))` (95% CI; `{r} print(round(ninf60_BF2$ninf_lo*ninf60_BF2$MIDAGE,digits = 2))` - `{r} print(round(ninf60_BF2$ninf_hi*ninf60_BF2$MIDAGE,digits = 2))`) cumulative salmonella infections inducing serotype-specific IgG response by age 0, 6, 12, 24 and 60 months respectively.

```{r echo=FALSE, warning=FALSE, message=FALSE, results=FALSE, fig.align = "centre", fig.height=6, fig.width = 5, out.width = "5.5in"}
#| fig-cap: Model 1 outputs using Markov Chain Monte Carlo (MCMC) to estimate model parameters, posterior chains and posterior distributions of parameters i, k, and mab
#| label: fig-posteriors1

summary(fit1$fit)
postsum1 <- as.data.frame(fit1$fit) %>% ## posteriors
  select(1:4) %>% 
  pivot_longer(cols = everything(), names_to = "variable", values_to = "value")
gg_hist <- ggplot(postsum1, aes(x=value))+
      geom_histogram(fill="lightblue",colour="black",lwd=0.2)+
      facet_wrap(~variable, nrow = 7, scales = "free") +
      labs(x = "Value", y = "Count") +
      theme(axis.text = element_text(size = 6),
           axis.title = element_text(size = 6))
chains_plot <- as_draws_df(fit1$fit) %>% 
  mcmc_trace(pars = vars(b_mab0_Intercept:sigma), facet_args = list(ncol = 1, strip.position = "left"))+
  #scale_color_pomological() +
  labs(title = "Trace plots") +
  theme(axis.text = element_text(size = 6),
        axis.title = element_text(size = 6),
        title = element_text(size=8, face="plain"))
  #theme_pomological_fancy(base_family = "Marck Script") 
plot_grid(gg_hist, chains_plot,ncol=2)
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results=FALSE, fig.align = "centre", fig.height=6, fig.width = 5, out.width = "5.5in"}
#| fig-cap: Model 2 outputs using Markov Chain Monte Carlo (MCMC) to estimate model parameters; posterior chains and posterior distributions of parameters i, k, and mab
#| label: fig-posteriors2

# plot posteriors
summary(fit2$fit)
postsum2 <- as.data.frame(fit2$fit) %>% ## posteriors
  select(1:7) %>% 
  pivot_longer(cols = everything(), names_to = "variable", values_to = "value")
gg_hist <- ggplot(postsum2, aes(x=value))+
      geom_histogram(fill="lightblue",colour="black",lwd=0.2)+
      facet_wrap(~variable, nrow = 7, scales = "free") +
      labs(x = "Value", y = "Count") +
      theme(axis.text = element_text(size = 6),
           axis.title = element_text(size = 6))
chains_plot <- as_draws_df(fit2$fit) %>% 
  mcmc_trace(pars = vars(b_mab0_Intercept:sigma), facet_args = list(ncol = 1, strip.position = "left"))+
  #scale_color_pomological() +
  labs(title = "Trace plots") +
    theme(axis.text = element_text(size = 6),
          axis.title = element_text(size = 6),
          title = element_text(size=8, face="plain"))
  #theme_pomological_fancy(base_family = "Marck Script") 
plot_grid(gg_hist, chains_plot,ncol=2)
```

\newpage

<!-- changing the orientation to landscape --------------------------------- -->

```{=tex}
\KOMAoptions{paper=landscape,pagesize}
\recalctypearea
```
```{r echo=FALSE, warning=FALSE, message=FALSE, results=FALSE, fig.align = "centre", fig.height=7, fig.width = 7.5, out.width = "8in"}
#| fig-cap: Model 1 fit, blue points are fitted GMC by age band, blue shaded area are 95% prediction intervals, pink points are observed GMC, pink shaded area are 95% prediction intervals.
#| label: fig-fit1

ninfM1 <- gg_ninffunc(dataSn1)
gg_ninf1<- gg_ninffunc(dataSn1)
gg_cum_ninf1<- gg_ninffuncum(dataSn1)
gg_mab_phi1<- gg_mab_phi_fun(dataSn1)
gg_fit1<- gg_fit_func(dataS, c_eff_midage1)

plot1 <- plot_grid(gg_mab_phi1, gg_ninf1,gg_cum_ninf1, nrow=1)
print(plot_grid(plot1, gg_fit1, nrow=2, labels="AUTO", rel_heights=c(1,2)))

```

```{r echo=FALSE, warning=FALSE, message=FALSE, results=FALSE, fig.align = "centre", fig.height=7, fig.width = 8, out.width = "8.5in"}
#| fig-cap: Model 2 fit, blue points are fitted GMC by age band, blue shaded area are 95% prediction intervals, pink points are observed GMC, pink shaded area are 95% prediction intervals.
#| label: fig-fit2

ninfM2 <- gg_ninffunc(dataSn2)
gg_ninf2<- gg_ninffunc(dataSn2)
gg_cum_ninf2<- gg_ninffuncum(dataSn2)
gg_mab_phi2<- gg_mab_phi_fun(dataSn2)
gg_fit2<- gg_fit_func(dataS, c_eff_midage2)

plot1 <- plot_grid(gg_mab_phi2, gg_ninf2,gg_cum_ninf2, nrow=1)
print(plot_grid(plot1, gg_fit2, nrow=2, labels="AUTO", rel_heights=c(1,2)))
```

```{r echo=FALSE, warning=FALSE, message=FALSE, ft.align = "centre", ft.height=6, ft.width = 5, out.width = "5.5in"}
#| tbl-cap: Model comparison
#| label: tbl-sites
### Functions to run models and comparisons are in seromultilevel modelling project
loo_all %>% 
  flextable() %>% 
  fontsize(size=10, part = "body") %>% 
  fontsize(size=10, part = "header") %>% 
  fontsize(size=6, part = "footer") %>% 
  bold(i = 1, bold = TRUE, part = "header") %>%   
   set_header_labels(
    rowname = "Model",
    elpd_diff = "ELPD Difference",
    se_diff = "SE difference",
    elpd_waic = "ELPD WAIC", 
    se_elpd_waic = "SE ELPD WAIC", 
    p_waic = "P WAIC", 
    se_p_waic = "SE P WAIC",
    waic = "WAIC",
    se_waic = "SE WAIC") %>% 
  footnote(i=1, j=3:10,
           value = as_paragraph(
             c(
               "Theoretical Expected Log Pointwise predictive Density (ELPD) estimated by (Bayesian) leave-one out (LOO) cross-validation, ELPD difference is the difference in LOO between two models",
               "Standard Error of component-wise differences of ELPD LOO differences between two models",
               "ELPD Widely Applicable Information Criterion (WAIC)",
               "Standard Error of ELPD WAIC",
               "Pareto K-value??",
               "Standard error of Pareto K-value?",
               "Widely Applicable Information Criterion (WAIC)",
               "Standard Error of WAIC"
             )
           ),
           ref_symbols = c("a", "b", "c", "d", "e", "f", "g", "h"),
           part = "header")
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results=FALSE, fig.align = "centre", fig.height=7, fig.width = 8, out.width = "8.5in"}
#| fig-cap: Selected best model fit, blue points are fitted GMC by age band, blue shaded area are 95% prediction intervals, pink points are observed GMC, pink shaded area are 95% prediction intervals. A; Malawi (model 2), B; Kenya (model 2), C; Burkina Faso (model 2)
#| label: fig-fitsites

panel1 <- do.call("plot_grid", c(plotLs$`2`, ncol=2, labels="AUTO", label_size=8))
print(panel1)

```

```{r echo=FALSE, warning=FALSE, message=FALSE, ft.align = "centre", ft.height=6, ft.width = 5, out.width = "5.5in"}
#| tbl-cap: Posterior summaries for fitted parameters across 3 sub-Saharan African sites
#| label: tbl-sites_possum

sites_tab %>% 
  flextable() %>% 
  fontsize(size=8, part = "body") %>% 
  fontsize(size=8, part = "header") %>% 
  bold(i = 1, bold = TRUE, part = "header") %>%   
  add_header_row(values = c("Country","mab", "i", "k", "r", "lambdaB", "E")) %>% 
  set_header_labels(         # Rename the columns in original header row
    Country = "",
    i = "Mean (95% CI)",
    k = "Mean (95% CI)",
    r = "Mean (95% CI)",
    E = "Mean (95% CI)",
    mab = "Mean (95% CI)",
    lambdaB = "Mean (95% CI)"
  ) %>% 
  autofit()
```

\newpage

<!-- changing the orientation to portrait --------------------------------- -->

```{=tex}
\KOMAoptions{paper=portrait,pagesize}
\recalctypearea
```
```{r echo=FALSE, warning=FALSE, message=FALSE, ft.align = "centre", ft.height=6, ft.width = 5, out.width = "5.5in"}
#| tbl-cap: Model predictions of predicted proportion (or probability) of children in each age group who had a salmonella infection inducing a S.typhiurum specific IgG response, and predicted cumulative number of salmonella infections experienced by a child each age group over their lifetime.
#| label: tbl-sites_ninf

ninf_all2 %>% 
  flextable() %>% 
  fontsize(size=8, part = "body") %>% 
  fontsize(size=8, part = "header") %>% 
  bold(i = 1, bold = TRUE, part = "header") %>%   
   set_header_labels(         # Rename the columns in original header row
    AGEGROUP_mth = "Age Group (months)",
    ninf = "Proportion with infection",
    cum_ninf = "Cumulative infections"
  ) %>% 
  autofit()
```

## Discussion

This serocatalytic model using non-typhoidal salmonella (NTS) antibody data from children living in endemic settings in sub-Saharan Africa, demonstrates how using cross-sectional age-stratified serological data can be used to understand the mechanisms between the relationship between NTS exposures in children and the acquisition of natural immunity. Different hypotheses can be tested by developing mechanistic models able to explain the observed age-patterns in the serology data, including different components for the maternal antibody decay and the natural acquisition of systemic antibodies in the child, based on expected patterns of exposure to enteric pathogens by age. The model fitting to the data was improved assuming that the force of infection (lambda) of enteric NTS infections leading to S. typhimurium specific IgG responses increased around age of weaning (\~6 months). The hypothesis that children have a higher infections with enteric pathogens around the age of weaning, and that this increases exponentially as they become more mobile and able to explore their environment through oral contact is consistent with the observed age-stratified point prevalence of eNTS detected on stool microbiology in the SAiNTS study cohort in Malawi as demonstrated in chapter 5 (@fig-NTSculture). Although the figure shown in chapter 5 shows the age-distribution of all NTS serovars, the proportions of 0:4 and 0:9 antigen (corresponding to the immunodominant O-antigens found on S. typhimurium and S. enteritidis respectively) positive stool samples appear to be distributed similarly. This sigmoidal pattern of rapidly increasing stool postivity at weaning then plateau after 24 months has also been observed in shigella infections in children 0 - 24 months longitudinally followed up in in the MAL-ED study [@fig-MAL_ED; @rogawski_mcquade_epidemiology_2020]. There may be other physiological, immunological, and epidemiological host susceptibility age related factors that influence the duration and infective load of shedding of enteric NTS stool shedding in younger children compared to older children that may also explain this age pattern, however, the improved model fit assuming sigmoid enteric NTS infection with age, is consistent with the hypothesis that children are getting more infections inducing a *S*. typhimurium specific IgG response. It is likely there is cross-protective immunity between salmonella serovars due to a common immunodominant O-antigen sub-type, for example as shown in chapter 5, for the subset of samples analysed the only isolates that were O:4 or O:9 antigen positive, were not Salmonella enterica subspecies enterica, but Salmonella enterica subspecies salamae (subspecies II) on genomic sequencing (@tbl-NTSgen). Further testing on the remaining NTS isolates from stools in the SAINTS study is needed, but it appears that based on the prevalence of IgG antibodies to STm in the Malawian children, which will be predominantly against the O:4 antigen, although there may be some IgG responses of lower magnitude to other O-antigens such as O:12, these non-enterica subspecies are likely to be responsible for inducing antibody responses across all NTS species with the same O-Ag. It is unclear however, whether this also translates in to cross-protection against invasive disease.

Fitting the same model across the other VacciNTS sites, supports the hypothesis that the changing FOI with age was a better fit to the observed serological data across all 3 sites. The cumulative number of salmonella infections able to induce a *S*. typhimurium specific IgG response for each site was relatively similar across all 3 sites, with children at age 12 months predicted to to have experienced 1.5 to 2 infections by the age of 12 to 13 months in Malawi and Burkina Faso, and slightly lower at 1.3 - 1.8 infections in Kenya, however, 95% credible intervals were overlapping for all site estimates, i. The baseline estimate of lambda (FOI) was also relatively similar across all sites; however the interpretation of this needs to be considered carefully. As we are detecting serological responses at a population level, this represents prior infections, but the period for which this covers is not known.

As shown in the age-stratified epidemiology of enteric NTS infections in chapter 5, children have on-going infections even after they have acquired S. typhimurium IgG in ages above 24 months. This suggests that anti-STm IgG is not protective against further iNTS infections, but as the incidence of iNTS disease declines after 24 months, as children reach a plateau of anti-STm IgG, suggesting that anti-STm IgG may protective against invasive NTS disease. It is likely that children continue to have asymptomatic or sub-clinical NTS enteric infections, but the serum IgG is able to prevent the infection becoming systemic. As shown in S. typhi, IgA may be a more important correlate of protection against enteric NTS infections due to it's role in gut mucosal immunity, and IgG a correlate of protection for invasive NTS disease [@jin_vi-specific_2020].

### Limitations

Further data from longitudinal serological samples across a range of ages of children living in endemic settings could be informative in estimating antibody decay rates and making inferences about how long a single exposure may be detected by anti-STm IgG responses, as has been done for typhoid serosurveillance as discussed in chapter 1 [@aiemjoy_estimating_2021]. However, assessing NTS infections in the population based on serological data is more complex than S.typhi, as in endemic settings it appears that children are exposed to a high force of infection from an early age of life, and continue to be exposed to multiple antibody inducing infections throughout early childhood as indicated by the point prevalence of NTS detection in the stool samples collected from children in the SAiNTS study as demonstrated in chapter 5, and by the rapid increases in anti-S. typhimurium antibodies by the age of 24 months, as demonstrated by the data in this chapter. Therefore interpreting antibody levels at a single time point is difficult as it is unknown if a child has had a recent NTS infection and subsequent production of specific IgG and the production of antibody levels are still increasing, usually 10-14 days to detect a full serological response, or if the antibody levels are in decline after several months due to antibody decay. It is likely with repeated exposures in a high FOI setting, antibody levels are being continually boosted by continual infections until they reach a saturation point. Therefore it is difficult to directly infer the number of infections that has directly contributed to the antibody concentration at a particular point in time. In addition the antibody response is likely to reduce in magnitude after a certain number of infections have occurred, which has not been taken into account in this model. Incorporating the serological data from the paired samples collected in SAiNTS could help improve the understanding of this process, and model interpretation.

The force of infection may change with time, and further modeling will be required to take into account both age and time. It is likely there are seasonal changes in FOI due to the seasonal patterns of NTS infections detected in stools of children in Malawi, but also changes over the longer term over years. Understanding the epidemiology of enteric NTS infections over time in relation to the incidence of iNTS diesease as described in chapter 3, in the context of the epidemiology of host factor susceptibility will be key in understanding the relative roles of infection verse host immune response in determining iNTS disease incidence. There was no prior available in the literature for lambda, therefore the prior was based on literature for other enteric pathogens, including shigella (REF). Data for Salmonella Typhimurium only was analysed as this is the main serovar associated with iNTS globally, however the data for Salmonella enteritidis should also be analysed (?add to appendix), particularly as this is known to cause a higher proportion of invasive disease in Kenya.

## Conclusions

This model has demonstrated that our hypothesis of the dynamics of enteric NTS infections with age is consistent with the serological data, and more advanced models may be used to get a better understanding of the force of infection in different settings. It is important to understand the relationship between cross-protective immunity between NTS serovars sharing the same immunodominant O-antigens, to understand how natural immunity may be effective. Next steps include modeling age-stratified serological responses versus disease incidence, and cross-validation considering risk factors and epidemiological setting. Further work to investigate the impact of malaria on induction of IgG to Salmonella typhimurium and Salmonella enteritidis.
