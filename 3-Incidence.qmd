---
title: "Age-stratified incidence of invasive non-typhoidal Salmonella at Queen Elizabeth Central Hospital (QECH), Blantyre, Malawi 1996-2024"
format:    
  pdf:
    geometry:
      - top=20mm
      - bottom=20mm
      - left=20mm
      - right=20mm
    toc: true
    lof: true
    lot: true
    number-sections: true
    colorlinks: true
    include-in-header:
      text: |
        \usepackage{typearea}
    cite-method: citeproc
    bibliography: references.bib
    csl: diabetologia.csl
editor: visual
---

## Introduction

Non-typhoidal strains of Salmonella (NTS) are an important cause of enterocolitis, with an estimated disease burden of 95 million cases in 2017, but with a low case-fatality rate [@stanaway_global_2019-1]. However, non-typhoidal salmonella can cause serious life-threatening disease through invasion of the bloodstream, meninges and other normally sterile sites, a high case-fatality rate (14¬∑7%) [@marchello_incidence_2021]. Invasive non-typhoidal salmonella (iNTS) often presents with a non-specific febrile illness, and diagnosis can only be made on microbiological culture [@feasey_invasive_2012-1]. Invasive disease is predominantly seen in HIV-infected adults and children under 5 years with malaria, malnutrition and anaemia [@feasey_invasive_2012-1], in sub-Saharan Africa [@marchello_incidence_2021]. The serovar Salmonella Typhimurium has been found to account for 77%, and Salmonella Enteritidis for 17% globally of NTS invasive infections on a recent systematic review [@marchello_incidence_2021], with a range of other serovars accounting for the remainder.

Data from the Global Burden of Diseases Study 2017 [@stanaway_global_2019-1] showed the highest incidence of iNTS disease globally was in children under 5 years 34¬∑3 (23¬∑2 to 54¬∑7) per 100,000, reaching up to 150 (110-230) (ask Jeff Stanaway for numbers from figures) cases per 100,000 population in neonates and infants in sub-Saharan Africa. Antimicrobial resistance (AMR) of NTS isolates is high (75%) in all sub-Saharan African (sSA) regions and resistance to third-generation cephalosporins in 5% of NTS isolates, in all sSA regions, since 2010 [@tack2020].

The World Health Organization (WHO) recognises iNTS as a top-10 vaccine priority for Africa. Up-to-date incidence data is key to inform WHO policy and vaccine development consortiums. Understanding the age-distribution of iNTS disease incidence is key to inform vaccine strategies, particularly the role of targeted vaccines for high risk groups such as neonates and maternal iNTS vaccines. However, due to changes in epidemiology of NTS and host risk factors resulting from public health measures such as roll out of anti-retroviral therapy (ART) , malaria control programs and community feeding programs [@feasey_modelling_2015, @harris2019, @gordon_epidemics_2008] with differing impacts on iNTS incidence in adults compared to children, it is important to have up-to-date granular age-stratified data on the age-distributions of iNTS incidence. Incidence data broken down by age-group within the under 5 age-group has not been well documented in the literature.

The Queen Elizabeth Central Hospital (QECH)/ Malawi-Liverpool Wellcome (MLW) Research Program has been collecting blood culture data since 1996. It has one of the largest blood culture databases in sub-Saharan Africa. Previous data from Malawi has shown that iNTS disease peaked in Malawi in 2002 reaching epidemic incidence of 242 cases per 100,000 population [@feasey_three_2015], and has been steadiliy declining to 6.9 per 100,000 in 2019 [@wilson_incidence_2022]. However, the changing distribution by age over time was not explored in this paper. It is key to inform understanding local, national and international iNTS vaccine development and policy. This article presents updated iNTS age-stratified incidence data from Queen Elizabeth Central Hospital, Blantyre, Malawi over a 22 year period from 1998-2024.

## Methods

We retrospectively collected data on culture confirmed iNTS disease, age and antimicrobial susceptibility, through Queen Elizabeth Central Hospital (QECH), Blantyre, Malawi from January 1998 through May 2024.

### Data sources

#### Population denominators

For the Blantyre district were interpolated from national population census data collected in 1998, 2008, and 2018 (NSO).

#### Blood culture data

Since 1998, the Malawi Liverpool Wellcome (MLW) Research Programme has provided a standard, routine blood culture service to patients presenting with febrile illness at the largest tertiary health care facility, Queen Elizabeth Central Hospital (QECH), in Blantyre, Malawi. Blood cultures are collected for adults with suspected sepsis or an axillary temperature \>37.5^o^C. Paediatric blood cultures are taken from febile children who have no parasitaemia on thick blood films or negative rapid diagnostic test, or from children with severe malaria and suspected secondary bacterial sepsis, or suspected sepsis regardless of fever or malaria diagnostic test result. Enhanced community blood culture surveillance was carried out during the STRATAA [@meiring_burden_2021] , and TyVAC clinical trial [@patel_safety_2021, @patel2024] within Blantyre. Non-typhoidal salmonella blood and CSF (cerebrospinal fluid) culture surveillance at QECH continued uninterrupted through all four waves of COVID-19, however, blood culture activities in the TyVAC study were suspended during the first wave [@patel2024].

#### Laboratory methods

Diagnostic microbiology was carried out at the MLW laboratories in Blanytre, Malawi, according to standard microbiological techniques \[\@cowanan1993\]. Blood cultures were collected into adult aerobic and paediatric anaerobic bottles (BACT/ALERT, Biomerieux), and analysed using automated systems. Cerebrospinal fluid (CSF) was cultured at 37.5oC on sheep blood (Oxoid, Category number: CMOO55) and chocolate agar (Oxoid, Category number: CMOO55) for 48 hours in a carbon dioxide incubator (LEEC incubator; Make/Model: GA 2000/2010). Gram-negative colonies were subcultured onto MacConkey (Oxoid, Category number: CM0007) and sheep blood agar. Biochemical profiles using API 20E or 10S were used to identify Salmonella, and serotyping was carried out using the White-Kauffman classification using polyvalent O and H, O4, O6, O7, O9, Hd, Hg, Hm and Vi antisera (Pro-Lab Diagnostics).

Disc diffusion using ampicillin, chloramphenicol, cotrimoxazole, cefpodoxime, and ciprofloxacin was used to determine antimicrobial susceptibility as described in \[\@wilson_incidence_2022, \@feasey_three_2015\]. Since 2009, isolates found to be resistant to ciprofloxacin or ceftriaxone by disc testing have had Etests (bioM√©rieux) performed. Fully susceptible isolates were defined as susceptiblity to ampicillin, chloramphenicol, cotrimoxazole, cefpodoxime, and ciprofloxacin and multidrug resistant (MDR) if resistant to ampicillin, cotrimoxazole, and chloramphenicol. Before October 2010, blood culture resulted were recorded by hand, then double-entered into a validated database. Following 2010, results have been directly entered into Prelink (Prelink V3.0.2429.0), laboratory information management system.

### Statistical methods

#### Incidence of invasive non-typhoidal salmonella

Data analysis was conducted in the r statistical environment [@r_core_team_r_2018]. Incidence was calculated using the sum of NTS positive blood and CSF cultures for a given year over the mid-year population estimate for that year.

To estimate incidence for children under 5 years, we selected a negative binomial distribution to account for overdispersion, to model monthly counts of NTS cases as a function of age, with b-splines fitted for smoothing.

Interrupted Time-Series Model:

$$ log(iNTS cases) = ~ \alpha + \beta_{2}*bspline(age, df=8) + log(population) $$Due to reporting bias for childrens ages (more likely to be reported nearest to the closest whole year), and the required granularity of data for incidence in the under 5 years, numbers for each year above the age of 12 months were redistributed equally across the 12 month age groups between each whole year of age.

#### Blood culture collection rates in Queen Elizabeth Hospital pre and post COVID pandemic in Malawi

An interrupted time-series analysis was conducted to measure the impact of COVID-19 on rates of blood culture collection.¬†A state of emergency was declared by the Malawian government and COVID-19 preventive measures were put in place. It was assumed that the measures taken in response to the pandemic would cause both an immediate ‚Äústep change‚Äù change in blood culture collection numbers, and a ‚Äúslope change‚Äù that may lead to a different monthly pattern of blood culture numbers compared to pre-COVID. These same assumptions were used for both the blood culture collection and health care attendance models. A negative binomial distribution was used to account for overdispersion, to model monthly counts of paediatric blood cultures taken as a function of month, COVID-19, and month-given-COVID (Model 1). Data from January 2016 onwards was used to gain the best estimate of baseline blood collection rates pre-COVID-19. Due to non-linear patterns in blood collections by season, to improve model fit models were generated with harmonic terms to account for seasonal peaks. Model selection was based on Akaike information criterion (AIC) using the AICcmodavg r package [@mazerolle_mj_aiccmodavg_2023]. Autocorrelation plots of residuals were plotted to assess residual seasonal patterns unaccounted for by the model.

Interrupted Time-Series Model (single step-change following onset of COVID in Malawi

$$ log(BCcount) = ~ \alpha + \beta_{2}*harmonics(month_n,1,12) + log(population) $$

Where *BCcount* = expected numbers of blood cultures collected per month, ùú∂ = intercept, *covid* = indicator variable for period before or after introduction of COVID restrictions (before or after 1st April 2020), *month* = indicator for month from Jan 2016, and *population* = estimated monthly population denominator for Blantyre District.

#### Salmonella serovar subgroup analysis

Due to high iNTS disease incidence reported from previous studies in children under 5 years, and as this age group is of key interest for vaccine development, subgroup analysis was carried out to estimate age-distributions of iNTS in children under 5 years of age. Analysis was carried out on all Salmonella serovars, and also restricted to the serovars (*S*. typhimurium and *S*. enteritidis) that are the predominant causes of invasive NTS disease globally [@marchello_incidence_2021], and are the serovars vaccines in current development are targeted against [@gvgh_advancing_2019] .

```{r, echo=FALSE, warning=FALSE, message=FALSE}

if(knitr::is_html_output()) {
  size_list <- list(
    legend_text = 7,
    legend_title = 11,
    legend_space = 0.5,
    fig_height = 6,
    fig_width = 8
  )
} else if (knitr::is_latex_output()) {
  size_list <- list(
    legend_text = 7,
    legend_title = 10,
    legend_space = 0.3,
    fig_height = 6,
    fig_width = 8
  )
}
###################################
## iNTS cases Queens 2012 to 2020 ##
####################################
library(readxl)
library(dplyr)
library(ggplot2)
library(lubridate)
library(Hmisc)
library(tidyr)
library(naniar)
library(tidyverse)
library(here)
library(rio)
library(janitor)
library(flextable)
library(officer)
library(officedown)
library(MASS)
library(dplyr) # load after due to select clashing
library(splines)
library(splines2)
library(cowplot)

source(here("scripts", "merge_function_diagnostics.R"))
source(here("scripts", "facet_coord_adjust.R")) ###https://www.zachburchill.ml/ggplot_facets/

## Import data
master_1996_2024 <- import(here("data","3_data", "masteriNTS_1996_2024.csv"))
PopYTot <- import(here("data","3_data", "DemographicBTPop.csv"))
BTCens <- import(here("data","3_data", "Interpolated_BTCensus_1996_2023.csv"))
BTCensAge <- import(here("data","3_data", "Interpolated_BTCensus_1996_2023Age.csv"))
Pop_10yr <- import(here("data","3_data", "Pred_BTCensus_1996_202310yAge.csv"))
CensYrBand <- import(here("data","3_data", "CensYrBand.csv"))
Pop_wideAgeband <- import(here("data","3_data", "Pop_wideAgeband.csv"))
BC_1998_2022 <- import(here("data","3_data", "BC_allAges_1998_2022.csv")) %>% 
  row_to_names(1)
AMR_paeds2 <- import(here("data","3_data", "AMR_paeds2.csv"))


sect_properties <- prop_section(
  page_size = page_size(
    orient = "landscape",
    width = 6, height = 10
  ),
  type = "continuous",
  page_margins = page_mar()
)

PopYwide <- data.frame(t(PopYTot)) %>%  ## Adding in data from Chu Kang demographic numbers
  row_to_names(1) %>% 
  rownames_to_column(var="Organism")

# Include missing ages for overall incidence, but remove the 0 ages form age analysis. Age 0 = likely missing
# all_yrs_BC <- master_1996_2024

all_yrs_BC_sum <- master_1996_2024 %>% 
  group_by(Year, Organism) %>% 
  summarise(count=n()) %>% 
  ungroup() 

all_yrs_BC_sumpop <- all_yrs_BC_sum %>% 
  left_join(PopYTot) %>% 
  mutate_all(~replace(., is.na(.), 0)) %>% 
  # mutate(population = as.numeric(pop)) %>%
  pivot_wider(id_cols = Organism, names_from = Year, values_from = count)

all_yrs_BC_sumTot <- all_yrs_BC_sumpop %>% 
  summarise(across(where(is.numeric), ~ sum(., na.rm = TRUE))) 

all_yrs_BC_sumFin <- all_yrs_BC_sumpop %>% 
  bind_rows(all_yrs_BC_sumTot, PopYwide) %>% 
  mutate(Organism = ifelse(is.na(Organism), "Total", Organism)) 
all_yrs_BC_sumFinFT <-flextable(all_yrs_BC_sumFin) 

#### Add line for BT interpolated figures for comparison
BTCens_wide <- BTCens %>% 
  pivot_wider(names_from = Year, values_from = Total) %>% 
  rownames_to_column() %>% 
  rename(Organism = rowname) %>% 
  mutate(Organism = ifelse(Organism==1, "Population Raw", "Population"))

all_yrs_BC_sumFin2 <- all_yrs_BC_sumFin %>% 
  bind_rows(BTCens_wide, BC_1998_2022)

n <- all_yrs_BC_sumFin2$Organism
# transpose all but the first column (name)
inc_tab_long <- as.data.frame(t(all_yrs_BC_sumFin2[,-1])) %>% 
  round(digits = 0)
colnames(inc_tab_long) <- n

inc_tab_long$Year <- row.names(inc_tab_long)
# inc_tab_long <- inc_tab_long %>%
#   mutate(Year = as.integer(Year))

## Calculate incidence 
inc_tab_long2 <- inc_tab_long %>% 
  mutate(min_inc = (Total/`Population Raw`)*100000) %>% 
  relocate(Year, .before = `Salmonella Enteritidis`) %>% 
  relocate(`Salmonella Typhimurium`, .before = `Salmonella Enteritidis`) %>%
  relocate(min_inc, .before = BC_total) %>% 
  dplyr::select(-Population) %>% 
  mutate(Year = as.integer(Year),
         BC_pos = Total/BC_total*100) %>% 
  rename(
    "Blood Cultures Collected" = BC_total,
    "Minimum Incidence" = min_inc
  ) %>% 
  # mutate_if(is.numeric, round, 0) %>% 
  mutate(across(c(2:6,8), round, 0)) %>%  # columns 2-7 by position
  mutate(across(c(7,9), round, 2)) # columns 2-7 by position

totals <- inc_tab_long2 %>% 
  summarise(across(where(is.numeric), ~ sum(.x, na.rm=T))) %>% 
  mutate(Year="Total")

## Age stratifications
age_gp <- master_1996_2024 %>% 
  mutate(Age_years = ifelse(Age_years>0,Age_years, NA),
        agebands = cut(Age_years, breaks = c(seq(0,55,5),65,75,90), labels=c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-64", "65-74", "75+")),
         agebands_s = cut(Age_years, breaks = c(0,5,10,15,30,50,90)),
         agebands_3 = cut(Age_years, breaks = c(0,15,45,90)),
         agebands_m = cut(Age_years, breaks = c(0,5,10,15,30,40,50,60,75,90)),
         YearBand = cut(Year, breaks = c(1995, 2005, 2015, 2024)),
         YearBand = factor(YearBand, labels = c("1996-2004", "2005-2014", "2015-2024")),
         YearBand2 = cut(Year, breaks = c(2010, 2015, 2020, 2024), labels = c("2010-2014","2015-2019","2020-2024")),
         YearBand3 = cut(Year, breaks = c(seq(1995,2025,5)), labels = c("1996-2000","2001-2005","2006-2010","2011-2015","2016-2020","2021-2024")))

alliNTSAgeYr <- age_gp %>% 
  group_by(agebands_s, Year) %>% 
  summarise(Total_iNTS = n()) %>% 
  ungroup() %>% 
  mutate(agebands2 = case_when(
    agebands_s=="(0,5]" ~ "x00_04", 
    agebands_s=="(5,10]" ~ "x05_09", 
    agebands_s=="(10,15]" ~ "x10_14", 
    agebands_s=="(15,30]" ~ "x15_30", 
    agebands_s=="(30,50]" ~ "x30_50", 
    agebands_s=="(50,90]" ~ "x50_90"
  )) %>% 
  pivot_wider(id_cols = "Year", names_from = "agebands2", values_from = "Total_iNTS", names_glue = "{agebands2}_count") %>% 
    left_join(Pop_wideAgeband) %>% 
  mutate(Inc00_04 = x00_04_count/x00_04_pop*100000,
         Inc05_09 = x05_09_count/x05_09_pop*100000,
         Inc10_14 = x10_14_count/x10_14_pop*100000,
         Inc15_30 = x15_30_count/x15_30_pop*100000,
         Inc30_50 = x30_50_count/x30_50_pop*100000,
         Inc50_90 = x50_90_count/x50_90_pop*100000,
         Year = as.character(Year))

####
alliNTSAge2 <- age_gp %>% 
  group_by(agebands) %>% 
  summarise(Total_iNTS = n()) %>% 
  ungroup()

alliNTSAge3 <- age_gp %>% 
  group_by(agebands_3) %>% 
  summarise(Total_iNTS = n()) %>% 
  ungroup()

alliNTSAgey <- age_gp %>% 
  group_by(agebands, YearBand) %>% 
  summarise(Total_iNTS = n()) %>% 
  ungroup()

alliNTSAge <- age_gp %>% 
  group_by(agebands_3, Year) %>% 
  summarise(Total_iNTS = n()) %>% 
  ungroup()

alliNTSAgeSero <- age_gp %>% 
  group_by(agebands, Organism) %>% 
  summarise(Total_iNTS = n()) %>% 
  ungroup()

alliNTSAgeSeroYr <- age_gp %>% 
  group_by(agebands, Organism, YearBand) %>% 
  summarise(Total_iNTS = n()) %>% 
  ungroup()

alliNTSAgeSeroYr2 <- age_gp %>% 
  group_by(agebands, Organism, YearBand3) %>% 
  summarise(Total_iNTS = n()) %>% 
  ungroup()
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#| echo: false
####
# Descriptive stats
sum_stats <- data.frame(colSums(inc_tab_long2[,-1], na.rm=T)) %>% t() %>% data.frame() %>% clean_names()
# iNTS_tot <- sum_stats$
stdate <- min(master_1996_2024$sampledate, na.rm=T)
endate <- max(master_1996_2024$sampledate, na.rm=T)
startpop <- min(inc_tab_long2$`Population Raw`, na.rm=T)
endpop <- max(inc_tab_long2$`Population Raw`, na.rm=T)
startyr <- min(inc_tab_long2$Year, na.rm=T)
endyr <- max(inc_tab_long2$Year, na.rm=T)
lowcount <- min(inc_tab_long2$Total,na.rm=T)
hicount <- max(inc_tab_long2$Total, na.rm=T)
lowinc <- min(inc_tab_long2$`Minimum Incidence`,na.rm=T)
hiinc <- max(inc_tab_long2$`Minimum Incidence`, na.rm=T)
inc_tab_long2a <- inc_tab_long2 %>% mutate(Min_inc = `Minimum Incidence`)
initinc1996 <- filter(inc_tab_long2a) %>% filter(Year==1996) 
initinc2002 <- filter(inc_tab_long2a) %>% filter(Year==2002) 
initinc2021 <- filter(inc_tab_long2a) %>% filter(Year==2021) 

lowyr <- inc_tab_long2 %>% 
  slice_min(order_by = `Minimum Incidence`, n=1) %>% 
  dplyr::select(Year)
hiyr <- inc_tab_long2 %>% 
  slice_max(order_by = `Minimum Incidence`, n=1) %>% 
  dplyr::select(Year)

tot_missAgeYr <- alliNTSAge %>% filter(is.na(agebands_3))
totmiss <- tot_missAgeYr %>% 
  summarise(tot_miss = sum(Total_iNTS))
NomissYrMax <- tot_missAgeYr %>% slice_max(Total_iNTS)
NomissYrMin <- tot_missAgeYr %>% slice_min(Total_iNTS)
# Yrmissmax <- tot_missAgeYr %>% subset(Total_iNTS==NomissYrMax, Year)
# Yrmissmin <- tot_missAgeYr %>% subset(Total_iNTS==NomissYrMin, Year)
tot_Yr <- alliNTSAge %>% 
  # slice_max(Total_iNTS) %>% 
  group_by(Year) %>% 
  summarise(Total_iNTS = sum(Total_iNTS, na.rm = T)) 
tot1996 <- tot_Yr %>% filter(Year==1996)

NomissYrMax_n <- NomissYrMax %>%
  left_join(tot_Yr, by="Year", suffix = c("mis", "tot")) %>% 
  mutate(perc_miss = (Total_iNTSmis/Total_iNTStot)*100,
         perc_miss = round(perc_miss, digits=1))
NomissYrMin_n <- NomissYrMin %>%
  left_join(tot_Yr, by="Year", suffix = c("mis", "tot")) %>% 
  mutate(perc_miss = (Total_iNTSmis/Total_iNTStot)*100,
         perc_miss = round(perc_miss, digits=1))        
# nonemissmin <- alliNTSAge %>% 
#   filter(Total_iNTS==NomissYrMin & !is.na(agebands_3)) %>% 
#   summarise(Total_iNTS = sum(Total_iNTS, na.rm=T),
#             perc_miss = (NomissYrMin/Total_iNTS)*100,
#             perc_miss = round(perc_miss, digits = 1))
# nonemissmax <- alliNTSAge %>% 
#   filter(Total_iNTS==NomissYrMax & !is.na(agebands_3)) %>% 
#   summarise(Total_iNTS = sum(Total_iNTS, na.rm=T),
#             perc_miss = (NomissYrMax/Total_iNTS)*100,
#             perc_miss = round(perc_miss, digits = 1))

# tot_missAge <- tot_missAgeYr %>% summarise(n())
totBC <- sum(inc_tab_long2$`Blood Cultures Collected`, na.rm=T)

## Age strat
count0_4 <- alliNTSAge2 %>% subset(agebands=="0-4", Total_iNTS)
count0_15 <- alliNTSAge3 %>% subset(agebands_3=="(0,15]", Total_iNTS)
count15_45 <- alliNTSAge3 %>% subset(agebands_3=="(15,45]", Total_iNTS)
count45_90 <- alliNTSAge3 %>% subset(agebands_3=="(45,90]", Total_iNTS)

# Age strat
alliNTSAgeYr <- alliNTSAgeYr %>% mutate_at(vars(starts_with("Inc")), funs(round(., 1)))
Age04inc1996 <- alliNTSAgeYr %>% filter(Year==1996) 
Age04incMax <- alliNTSAgeYr %>% slice_max(Inc00_04)
Age04incMin <- alliNTSAgeYr %>% slice_min(Inc00_04)
Age3050inc1998 <- alliNTSAgeYr %>% filter(Year==1998) 
Age3050incMax <- alliNTSAgeYr %>% slice_max(Inc30_50) 
Age3050incMin <- alliNTSAgeYr %>% slice_min(Inc30_50)

# organism
S04 <- alliNTSAgeSero %>% filter(agebands=="0-4")
S04_sum <- S04 %>% summarise(total = sum(Total_iNTS, na.rm=T))
STm04 <- S04 %>% filter(Organism=="Salmonella Typhimurium")
STm04_per <- round((STm04$Total_iNTS/S04_sum$total)*100,digits = 1)
SEn04 <- S04 %>% filter(Organism=="Salmonella Enteritidis")
SEn04_per <- round((SEn04$Total_iNTS/S04_sum$total)*100,digits = 1)
Spp04 <- S04 %>% filter(Organism=="Salmonella species")
Spp04_per <- round((Spp04$Total_iNTS/S04_sum$total)*100,digits = 1)
```

## Results

### Overall incidence

Data on NTS blood and CSF cultures was available from `{r} print(stdate)` to `{r} print(endate)`. During this period there were `{r} print(prettyNum(as.integer(sum_stats$total), big.mark=","))` cases of iNTS, including `{r} print(prettyNum(sum_stats$salmonella_typhimurium,big.mark=","))` S.typhimurium, `{r} print(prettyNum(sum_stats$salmonella_enteritidis,big.mark=","))` *S*.enteritidis, and `{r} sum_stats$salmonella_species` *S*.species (@tbl-sumtab). The total Blantyre population was `{r} print(prettyNum(as.integer(startpop),big.mark=","))` in `{r} print(startyr)` and `{r} print(prettyNum(as.integer(endpop),big.mark=","))` in `{r} print(endyr)`. During this period, the total numbers of NTS isolated from sterile sites ranged from `{r} print(initinc1996$Total)` with a corresponding minimum incidence of `{r} print(initinc1996$Min_inc)` per 100,000 person-years in `{r} print(initinc1996$Year)`, to `{r} print(hicount)` isolates corresponding to `{r} print(hiinc)` per 100,000 person-years minimum incidence in `{r} print(hiyr$Year)`, and to `{r} print(lowcount)` isolates corresponding to `{r} print(lowinc)` per 100,000 person-years minimum incidence in `{r} print(lowyr$Year)` (@tbl-sumtab, @fig-NoPeriod, @fig-HistInc A).

### Age-stratified incidence

Stratifying by age group, there were `{r} print(prettyNum(count0_15$Total_iNTS,big.mark=","))` NTS blood and CSF isolates collected from children aged 0 - 15 years of age, of which `{r} print(prettyNum(count0_4$Total_iNTS,big.mark=","))` were from children under 5 years within the study period `{r} print(stdate)` to `{r} print(endate)`. There were `{r} print(prettyNum(count15_45$Total_iNTS,big.mark=","))` NTS isolates from adults 15 - 45 years, and `{r} print(count45_90$Total_iNTS)` from adults 45 - 90 years of age during the same period. Data for age was missing for a total of `{r} print(prettyNum(totmiss$tot_miss, big.mark=","))` NTS isolates. The distribution of age categories and missing ages by year are shown in @fig-NoPeriod, panel C. The year with the highest number of missing ages for isolates was `{r} print(NomissYrMax_n$Total_iNTSmis)` isolates (`{r} print(NomissYrMax_n$perc_miss)` %) in `{r} print(NomissYrMax$Year)` the year with the lowest number of missing age values was `{r} print(NomissYrMin_n$Total_iNTSmis)` (`{r} print(NomissYrMin_n$perc_miss)` %) isolates in `{r} print(NomissYrMin$Year)` (@fig-NoPeriod, C). Where data was available for age; there were `{r} print(Age04inc1996$x00_04_count)` NTS isolates with a minimum incidence of `{r} print(Age04inc1996$Inc00_04)` per 100,000 person-years for children aged 0 - 4 years in `{r} print(Age04inc1996$Year)`, rising to `{r} print(Age04incMax$x00_04_count)` NTS isolates and incidence of `{r} print(Age04incMax$Inc00_04)` in `{r} print(Age04incMax$Year)`, and `{r} print(Age04incMin$x00_04_count)` NTS isolates and incidence of `{r} print(Age04incMin$Inc00_04)` in `{r} print(Age04incMin$Year)`(@fig-HistInc B). Adults aged 30 - 50 years had `{r} print(Age3050inc1998$x30_50_count)` NTS isolates and incidence of `{r} print(Age3050inc1998$Inc30_50)` per 100,000 person-years in `{r} print(Age3050inc1998$Year)`, `{r} print(Age3050incMax$x30_50_count)` NTS isolates and incidence of `{r} print(Age3050incMax$Inc30_50)` per 100,000 person-years in `{r} print(Age3050incMax$Year)`, and `{r} print(Age3050incMin$x30_50_count)` NTS isolates and incidence of `{r} print(Age3050incMin$Inc30_50)` per 100,000 person-years in `{r} print(Age3050incMin$Year)`. Of all NTS isolates in the youngest age group (0 - 4 years); S.typhimurium accounted for `{r} print(STm04$Total_iNTS)` (`{r} print(STm04_per)`%), S.enteritidis for `{r} print(SEn04$Total_iNTS)` (`{r} print(SEn04_per)`%) and S.species for `{r} print(Spp04$Total_iNTS)` (`{r} print(Spp04_per)`%) (@fig-NoPeriod D).

```{r echo=FALSE, results='hide', warning=FALSE, message=FALSE, fig.align = "left"}
#| fig-height: !expr size_list$fig_height
#| fig-width: !expr size_list$fig_width
#| label: fig-NoPeriod
#| fig-cap: Number of Non-Typhoidal Salmonella blood culture isolates A + B. By time period, C. By age group over time, and D. By serovar at Queen Elizabeth Central Hospital (QECH), 1996-2024.
#| 
p96_15 <- age_gp %>% 
  filter(Year<2016) %>% 
  ggplot(aes(x=Age_years, fill=YearBand)) +
  geom_histogram(colour="black", lwd=0.1, binwidth = 1, alpha = 0.65) +
  scale_x_continuous(breaks = seq(0,90,5))+
  theme_bw() +
  ggtitle("1996-2015")+
  guides(fill = guide_legend(title = "Year Band"),
         colour = guide_legend(title = "Year Band"))+
  labs(x="Age (years)",y="Total iNTS")+
  theme(title = element_text(face = "bold", size=8),
        axis.title = element_text(face= "bold" , size = 6),
        axis.text = element_text(face = "plain", size = 6),
        axis.text.x = element_text(face = "plain", size = 6, vjust = 0.5),
        legend.text = element_text(face = "plain", size = 6),
        legend.title = element_text(face = "bold", size = 8))


p10_24 <- age_gp %>% 
  filter(Year>2009) %>% 
  ggplot(aes(x=Age_years, fill=YearBand2)) +
  geom_histogram(colour="black", lwd=0.2, binwidth = 1, alpha = 0.65,
                 position = "identity") +
  scale_x_continuous(breaks = seq(0,90,5))+
  scale_fill_manual(values = c("#8795E8", "#FF6AD5", "goldenrod"))+
  guides(fill = guide_legend(title = "Year Band"),
         colour = guide_legend(title = "Year Band"))+
  theme_bw() +
  ggtitle("2010-2024")+
  labs(x="Age (years)",y="Total iNTS")+
  theme(title = element_text(face = "bold", size=8),
        axis.title = element_text(face= "bold" , size = 6),
        axis.text = element_text(face = "plain", size = 6),
        axis.text.x = element_text(face = "plain", size = 6, vjust = 0.5),
        legend.text = element_text(face = "plain", size = 6),
        legend.title = element_text(face = "bold", size = 8))


porg <- alliNTSAgeSero %>% 
  mutate(Organism = case_when(
    str_detect(Organism, "Enteritidis") ~ "S.Enteriditis",
    str_detect(Organism, "species") ~ "S.Spp",
    str_detect(Organism, "Typhimurium") ~ "S.Typhimurium"
  )) %>% 
  ggplot(aes(x=agebands, y=Total_iNTS, fill = Organism))+
  geom_bar(stat="identity") +
  scale_fill_manual(values = c("aquamarine4", "goldenrod","orchid"))+
  ggtitle("1996-2024")+
  labs(x="Age (years)",y="Total iNTS")+
  theme_bw()+
  theme(title = element_text(face = "bold", size=8),
        axis.title = element_text(face= "bold" , size = 6),
        axis.text = element_text(face = "plain", size = 6),
        axis.text.x = element_text(face = "plain", size = 6, vjust = 0.5, angle = 45),
        legend.text = element_text(face = "plain", size = 6),
        legend.title = element_text(face = "bold", size = 8))

pAge <- ggplot(alliNTSAge, aes(x=Year, y = Total_iNTS, fill = agebands_3))+
  geom_bar(stat="identity")+
  ggtitle("1996-2024")+
  labs(y="Total iNTS")+
 # scale_x_discrete()+
  scale_fill_manual(values = c("#8795E8","goldenrod","#FF6AD5"))+
  guides(fill = guide_legend(title = "Age Band"),
         colour = guide_legend(title = "Age Band"))+
  theme_bw()+
  theme(title = element_text(face = "bold", size=8),
        axis.title = element_text(face= "bold" , size = 6),
        axis.text = element_text(face = "plain", size = 6),
        axis.text.x = element_text(face = "plain", size = 6, vjust = 0.5),
        legend.text = element_text(face = "plain", size = 6),
        legend.title = element_text(face = "bold", size = 8))

cowplot::plot_grid(p96_15,p10_24,pAge,porg, labels = "AUTO")
```

```{r echo=FALSE, results='hide', warning=FALSE, message=FALSE, fig.align = "left", fig.height=9, fig.width=6}
#| label: fig-HistInc
#| fig-cap: A. Overall incidence of non-typhoidal Salmonella by year B. Count of Non-Typhoidal Salmonella blood culture isolates by age group, Queen Elizabeth Central Hospital (QECH), 1996-2024, C. Minimum Incidence of Non-Typhoidal Salmonella blood culture isolates by age group, Queen Elizabeth Central Hospital (QECH), 1996-2024


# alliNTSAgeYrFT <- flextable(alliNTSAgeYr)
# alliNTSAgeYrFT <- set_table_properties(alliNTSAgeYrFT, layout = "autofit") %>% 
#   fontsize(size=8, part = "body") %>% 
#   fontsize(size=8, part = "header") 
#   alliNTSAgeYrFT
# doc <- read_docx()
# doc <- body_add_flextable(doc, value = alliNTSAgeYrFT, align = "left")
# print(doc, target = here("outputs", "iNTS_byYrAgbinSerovar.docx"),  pr_section = sect_properties)

## Overall incidence 
total_inc <- ggplot(inc_tab_long2, aes(x=Year, y=`Minimum Incidence`))+
  geom_line(colour="blue")+
  ggtitle("Minimum Incidence iNTS (BC) by age, QECH, Blanytre")+
  ylab("Incidence per 100,000 population")+
  # scale_x_continuous(breaks = seq(1996,2024,2))+
  theme_bw() +
  theme(axis.text.x = element_text(size=6,angle = 45),
        axis.title = element_text(face= "bold" , size = 8),
        legend.title = element_text(face = "bold", size = 6),
        title = element_text(face = "bold", size=8))

## Age-incidence plots
inc_agband_long <- alliNTSAgeYr %>% 
  pivot_longer(cols = c(Inc00_04, Inc05_09, Inc10_14, Inc15_30, Inc30_50, Inc50_90), names_to = "Ageband", values_to = "Incidence") %>% 
  dplyr::select(c(Year, Ageband, Incidence)) %>% 
  mutate(Ageband = factor(Ageband, levels = c("Inc00_04", "Inc05_09", "Inc10_14", "Inc15_30", "Inc30_50", "Inc50_90"),
         labels = c("0-4y", "5-9y", "10-14y", "15-30y","30-50y","50-90y")))

incAge <- ggplot(inc_agband_long, aes(x=Year, y=Incidence, group=Ageband, colour = Ageband))+
  geom_line()+
  ggtitle("Minimum Incidence iNTS (BC) by age, QECH, Blanytre")+
  # scale_x_continuous(breaks = seq(1996,2024,2))+
  ylab("Incidence per 100,000 population")+
  theme_bw() +
  theme(axis.text.x = element_text(size=6,angle = 45),
        axis.text = element_text(face = "plain", size = 6),
        axis.title = element_text(face= "bold" , size = 8),
        legend.text = element_text(face = "plain", size = 6),
        legend.title = element_text(face = "bold", size = 6),
        title = element_text(face = "bold", size=8))
# ggsave(here("outputs", "Incidence_agebands.png"))

### Incidence graphs in U5
#### U5
iNTS_all_U5 <- age_gp %>% 
  filter(Age_months<=60) %>% 
  mutate(agemth_rnd = round(Age_months, digits=0),
         agecat = cut(Age_months, breaks = c(0,12,24,36,48,60))) %>% 
  group_by(Year, agecat) %>% 
  summarise(midage = mean(Age_months, na.rm=T),
            count = n())

pAgeU5 <- ggplot(iNTS_all_U5, aes(x=Year, y = count, fill = agecat))+
  geom_bar(stat="identity")+
  ggtitle("Number of NTS isolates in children under 5 years (1996-2024)")+
  labs(y="Total iNTS")+
  # scale_x_continuous(breaks = seq(1996,2024,2))+
  guides(fill = guide_legend(title = "Age Band"),
         colour = guide_legend(title = "Age Band"))+
  theme_bw()+
  theme(title = element_text(face = "bold", size=8),
        axis.title = element_text(face= "bold" , size = 6),
        axis.text = element_text(face = "plain", size = 6),
        axis.text.x = element_text(face = "plain", size = 6, vjust = 0.5),
        legend.text = element_text(face = "plain", size = 6),
        legend.title = element_text(face = "bold", size = 6))

cowplot::plot_grid(total_inc, incAge, pAgeU5, nrow=3, labels="AUTO")

```

\newpage

<!-- changing the orientation to landscape --------------------------------- -->

```{=tex}
\KOMAoptions{usegeometry, paper=landscape,pagesize}
\recalctypearea
```
```{r echo=FALSE, warning=FALSE, ft.align = "centre", ft.width = 7, out.width = "7.5in"}
#| label: tbl-sumtab
#| tbl-cap: Non-Typhoidal Salmonella blood culture isolates from Queen Elizabeth Central Hospital (QECH), 1996-2024

inc_tab_long3 <- inc_tab_long2 %>%
  mutate(Year = factor(Year)) %>% 
  bind_rows(totals)  
inc_tab_longFT <- flextable(inc_tab_long3)
inc_tab_longFTFt <- inc_tab_longFT %>% 
  fontsize(size=8, part = "body") %>% 
  fontsize(size=8, part = "header") %>% 
  bold(i = 1, bold = TRUE, part = "header") %>%           
  add_header_row(values = c("Year","Serovar", "Total NTS", "Population", "Minimum Incidence", "Total Cultures", "Positivity (%)"),
                 colwidths = c(1,3,1,1,1,1,1),
                 top = TRUE) %>% 
  set_header_labels(
    Year = "",
    `Salmonella Typhimurium` = "S. Typhimurium", 
    `Salmonella Enteritidis` = "S. Enteritidis", 
    `Salmonella species` = "S. species", 
    Total = "",
    # Population = "Demographic",
    `Population Raw` = "Census",
    `Blood Cultures Collected` = "", 
    `Minimum Incidence` = "(Per 100,000 pop.)",
    BC_pos = ""
  ) %>% 
  colformat_double(j=c(1:8), digits=0) %>% 
  colformat_double(j=7, digits=1) %>% 
  colformat_double(j=9, digits=2) %>% 
  set_caption( 
    caption = "Non-Typhoidal Salmonella blood culture isolates from Queen Elizabeth Central Hospital (QECH), 1996-2024", 
    style = "Table Caption", 
    autonum = run_autonum(seq_id = "tab", bkm = "incidencetab1")) %>% 
  footnote(i=1, j=6,
           value = as_paragraph(c("Missing total blood culture data for 1996-1997")),
           ref_symbols = c("a"),
           part="header") %>% 
  valign(valign="bottom", part="header") %>% 
  flextable::align(., align = "left", j = c(1:8), part = "all") %>% 
  fontsize(size = 6, part = "footer") %>% 
  colformat_double() %>% 
  hline(i = ~ before(Year, "Total"), border = fp_border_default()) %>% 
  autofit()
inc_tab_longFTFt
# inc_tab_longFT <- set_table_properties(inc_tab_longFT, layout = "autofit") %>% 
doc <- read_docx()
doc <- body_add_flextable(doc, value = inc_tab_longFT, align = "left")
# print(doc, target = here("outputs", "iNTS_byYrSerovar.docx"),  pr_section = sect_properties)
```

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
redist_func <- function(df){
 df %>% 
    mutate(count_distributed = case_when(
      agemth_rnd %in% c(24, 36, 48, 60) ~ round(count / 13,digits=0),  # Distribute counts evenly
      agemth_rnd %in% c(12) ~ round(count / 17,digits=0),  # peak incidence is artifically low for 12 months, impating age distribution, weight according to 11 and 13 months trends
      TRUE ~ NA
    )) %>%
  ungroup() %>% 
  fill(count_distributed, .direction="down") %>% #fill = list(count_distributed = 0)
  mutate(count_new = case_when(
    !agemth_rnd %in% c(12, 24, 36, 48, 60) ~ count + count_distributed,
    agemth_rnd %in% c(24, 36, 48, 60) ~ 2*count_distributed,
    agemth_rnd == 12 ~ 5*count_distributed),
    count_new = ifelse(agemth_rnd <12, count, count_new)
  )
}

redist_funcyr <- function(df){
 df %>% 
    group_by(YearBand3, agemth_rnd) %>% 
    mutate(count_distributed = case_when(
      agemth_rnd %in% c(24, 36, 48, 60) ~ count / 13,  # Distribute counts evenly
      agemth_rnd ==12 & YearBand3=="1996-2000" ~ count / 22,  
      agemth_rnd ==12 & YearBand3=="2001-2005" ~ count / 20,  
      agemth_rnd ==12 & YearBand3=="2006-2010" ~ count / 18,  
      agemth_rnd ==12 & YearBand3=="2011-2015" ~ count / 16,  
      agemth_rnd ==12 & YearBand3=="2016-2020" ~ count / 15,  
      agemth_rnd ==12 & YearBand3=="2021-2024" ~ count / 13,  
      TRUE ~ NA
    )) %>%
    ungroup() %>% 
  fill(count_distributed, .direction="down") %>% #fill = list(count_distributed = 0)
  mutate(count_new = case_when(
    !agemth_rnd %in% c(12, 24, 36, 48, 60) ~ count + count_distributed,
    agemth_rnd %in% c(24, 36, 48, 60) ~ 2*count_distributed,
    agemth_rnd == 12 & YearBand3=="1996-2000" ~ 11*count_distributed,
    agemth_rnd == 12 & YearBand3=="2001-2005" ~ 9*count_distributed,
    agemth_rnd == 12 & YearBand3=="2006-2010" ~ 7*count_distributed,
    agemth_rnd == 12 & YearBand3=="2011-2015" ~ 5*count_distributed,
    agemth_rnd == 12 & YearBand3=="2016-2020" ~ 4*count_distributed,
    agemth_rnd == 12 & YearBand3=="2021-2024" ~ 2*count_distributed),
    count_new = ifelse(agemth_rnd <12, count, count_new)
  )
}

redist_funcyr2 <- function(df){
 df %>% 
    group_by(YearBand, agemth_rnd) %>% 
    mutate(count_distributed = case_when(
      agemth_rnd %in% c(24, 36, 48, 60) ~ count / 13,  # Distribute counts evenly
      agemth_rnd ==12 & YearBand=="1996-2004" ~ count / 22,  
      agemth_rnd ==12 & YearBand=="2005-2014" ~ count / 16,  
      agemth_rnd ==12 & YearBand=="2015-2024" ~ count / 15,  
      TRUE ~ NA
    )) %>%
    ungroup() %>% 
  fill(count_distributed, .direction="down") %>% #fill = list(count_distributed = 0)
  mutate(count_new = case_when(
    !agemth_rnd %in% c(12, 24, 36, 48, 60) ~ count + count_distributed,
    agemth_rnd %in% c(24, 36, 48, 60) ~ 2*count_distributed,
    agemth_rnd == 12 & YearBand=="1996-2004" ~ 10*count_distributed,
    agemth_rnd == 12 & YearBand=="2005-2014" ~ 4*count_distributed,
    agemth_rnd == 12 & YearBand=="2015-2024" ~ 3*count_distributed),
    count_new = ifelse(agemth_rnd <12, count, count_new)
  )
}

#mean(Pop_wideAgeband$x00_04_pop)
## Population
BTpop_u5 <- Pop_10yr %>% 
  dplyr::select(c(1,3)) %>% 
  mutate(YearBand3 = cut(Year, breaks = c(seq(1995,2025,5)), labels = c("1996-2000","2001-2005","2006-2010","2011-2015","2016-2020","2021-2024"))) %>% 
  group_by(YearBand3) %>% 
  summarise(pop = mean(x00_04_pop)) %>% 
  ungroup()

BTpop_u52 <- Pop_10yr %>% 
  dplyr::select(c(1,3)) %>% 
  mutate(YearBand = cut(Year, breaks = c(1995, 2005, 2015, 2024), labels = c("1996-2004", "2005-2014", "2015-2024"))) %>% 
  group_by(YearBand) %>% 
  summarise(pop = mean(x00_04_pop)) %>% 
  ungroup()

##### 
iNTS_all_U5_all <- age_gp %>% 
  filter(Age_months<=60 & Age_months>0) %>% 
  mutate(agemth_rnd = round(Age_months, digits=0)) 

NTS_all_U5_all_Stmen <- age_gp %>% 
  filter(Age_months<=60 & Age_months>0 & str_detect(Organism, "species", negate=T)) %>% 
  mutate(agemth_rnd = round(Age_months, digits=0)) 

iNTS_allage_sumyr <- CensYrBand %>% 
  full_join_track(alliNTSAgey) %>% 
  mutate(min_inc = Total_iNTS/pop)

iNTS_U5_1996_2024_sum <- iNTS_all_U5_all %>% 
  group_by(agemth_rnd) %>% 
  summarise(midage = mean(Age_months, na.rm=T),
            count = n()) %>%
  redist_func() %>% 
  mutate(pop = 2401,
         risk = (count_new/pop)*100000*12)
  
iNTS_U5_1996_2024_sumYr <- iNTS_all_U5_all %>% 
  group_by(YearBand3, agemth_rnd) %>% 
  summarise(midage = mean(Age_months, na.rm=T),
            count = n())%>% 
  ungroup() %>% 
  redist_funcyr() %>% 
  left_join(BTpop_u5) %>% 
  mutate(risk = (count_new/pop)*100000*12)

iNTS_U5_1996_2024_sumYr2 <- iNTS_all_U5_all %>% 
  mutate(agemth_rnd = round(Age_months, digits=0)) %>% 
  group_by(YearBand, agemth_rnd) %>% 
  summarise(midage = mean(Age_months, na.rm=T),
            count = n())%>% 
  ungroup() %>% 
  redist_funcyr2() %>% 
  left_join(BTpop_u52) %>% 
  mutate(risk = (count_new/pop)*100000*12,
         ageyrs = agemth_rnd/12)

iNTS_U5_1996_2024_sumYra <- NTS_all_U5_all_Stmen %>% 
  group_by(YearBand3, agemth_rnd) %>% 
  summarise(midage = mean(Age_months, na.rm=T),
            count = n())%>% 
  ungroup() %>% 
  redist_funcyr() %>% 
  left_join(BTpop_u5) %>% 
  mutate(risk = (count_new/pop)*100000*12)
### Distribute ages evenly >1yr
### Distribute ages across ages months >1yr
# iNTS_U5_1996_2024_sumYr2 <- iNTS_U5_1996_2024_sumYr2 %>% 
#   mutate(
#     count_add = ifelse(ageyrs==as.integer(ageyrs),count/13,NA),  ## Split into 13 groups so can have 2 in first group as will be adding in extra from those with data to other groups
#     count_adj = ifelse(ageyrs==as.integer(ageyrs),(count/13)*2,count)) %>% 
#   group_by(YearBand) %>% 
#   fill(count_add) %>% 
#   mutate(count_adj = count_add + count_adj,
#          count_adj = ifelse(ageyrs<1, count, count_adj),
#          risk = count_adj/(pop/12)*100000)

# ggplot(iNTS_U5_1996_2024_sumYr2, aes(x=ageyrs, y=risk, group=YearBand, colour = YearBand))+
#   geom_line()+
#   ggtitle("Minimum Incidence iNTS (BC) by age, QECH, Blanytre")+
#   ylab("Incidence per 100,000 population")+
#   theme_bw() +
#   theme(axis.text.x = element_text(size=6,angle = 45))

## Combine granular months U5 to other agebands
allageYrB3 <- iNTS_U5_1996_2024_sumYr2 %>% 
  bind_rows(iNTS_allage_sumyr)
  
# ggplot(allageYrB3, aes(x=ageyrs, y=risk, group=YearBand, colour = YearBand))+
#   geom_line()+
#   ggtitle("Minimum Incidence iNTS (BC) by age, QECH, Blanytre")+
#   ylab("Incidence per 100,000 population")+
#   coord_cartesian(ylim = c(0,5000))+
#   theme_bw() +
#   theme(axis.text.x = element_text(size=6,angle = 45))

iNTS_U5_1996_2024_sumOrg <- iNTS_all_U5_all %>% 
  mutate(agemth_rnd = round(Age_months, digits=0)) %>% 
  group_by(agemth_rnd, Organism) %>% 
  summarise(midage = mean(Age_months, na.rm=T),
            count = n()) %>% 
  ungroup() %>% 
  mutate(pop = 2401,
         risk = count/pop*100000)

# ggplot(iNTS_U5_1996_2024_sumOrg, aes(agemth_rnd, count, fill = Organism))+
#   geom_bar(stat="identity")+
#   xlab("Age")+
#   ylab("Count")+
#   theme_bw() +
#   theme(title = element_text(face = "bold", size=16),
#         axis.title = element_text(face= "bold" , size = 10),
#         axis.text = element_text(face = "plain", size = 10),
#         legend.text = element_text(face = "plain", size = 10),
#         legend.title = element_text(face="bold", size=10))

## Combine granular months U5 to other agebands
allageYrB3 <- iNTS_U5_1996_2024_sumYr2 %>% 
  bind_rows(iNTS_allage_sumyr)
  
# ggplot(allageYrB3, aes(x=ageyrs, y=risk, group=YearBand, colour = YearBand))+
#   geom_line()+
#   ggtitle("Minimum Incidence iNTS (BC) by age, QECH, Blanytre")+
#   ylab("Incidence per 100,000 population")+
#   theme_bw() +
#   theme(axis.text.x = element_text(size=6,angle = 45))

### Fit risk
risk_predict <- function(df, name ){ #Switch, grp
  spline_risk <-glm.nb(count_new ~ bs((midage), df=8)+ offset(log(pop)), df) 
  pred_obj <- predict(spline_risk, type="link", data=df, se.fit=T)
  df2 <- df %>%
  mutate(case_pred=exp(pred_obj$fit),
         risk_pred=exp(
           pred_obj$fit - log(pop)
         )*100000*12,
         cases_low=exp(pred_obj$fit - 1.96*pred_obj$se.fit),
         cases_high=exp(pred_obj$fit + 1.96*pred_obj$se.fit),
         risk_low=exp(
           (pred_obj$fit - 1.96*pred_obj$se.fit) - log(pop)
         )*100000*12,
         risk_high=exp(
           (pred_obj$fit + 1.96*pred_obj$se.fit) - log(pop)
         )*100000*12,
         cases_se=pred_obj$se.fit,
         cases_link=pred_obj$fit,
         sd=(risk_high-risk_low/3.92)*sqrt(count_new),
         cumulative_risk = cumsum(risk_pred),
         cum_risk_low = cumsum(risk_low),
         cum_risk_high = cumsum(risk_high),
         cum_cases_pred = cumsum(case_pred),
         cum_cases_low = cumsum(cases_low),
         cum_cases_high = cumsum(cases_high)
  )
  # export(df2, here("data","3_data", paste(sep="",name,"risk_per_mthU5.csv")))
  return(df2)

}

risk_predict(iNTS_U5_1996_2024_sum, "All")
risk_predict(iNTS_U5_1996_2024_sumYr, "Yr")
#risk_predict(iNTS_U5_1996_2024_sumOrg, "Org")

subgrp <- function(df,grp,name,lab){
  df2 <- df %>% 
    filter(str_detect(grp,name))
  return(risk_predict(df2,lab))
}

plotfunc <- function(df,grp,name){
  plot <- ggplot(df) +
    geom_line(aes(y=risk_pred, x=midage, colour = grp)) +
    geom_ribbon(aes(ymax=risk_high, ymin=risk_low, x=midage, colour = grp, fill=grp), alpha=0.3 ) +
    geom_point(aes(y=risk, x=midage, colour = grp), shape=1) +
    theme_bw() +
    scale_x_continuous(breaks = c(seq(0,60,6))) +
    xlab("Mid-age in months") +
    ylab("Incidence per 100,000 population")+
    # ggtitle("1996-2024") +
    guides(color=guide_legend("Group"), fill = guide_legend("Group"))+
    #labs(fill='Group')+
    #scale_fill_manual('Group')+
    coord_cartesian(xlim = c(0,60))+ #ylim = c(0,2500)
    theme(title = element_text(face = "bold", size=10),
          axis.title = element_text(face= "plain" , size = 10),
          axis.text = element_text(face = "plain", size = 8),
          axis.text.x = element_text(face = "plain", size = 8, vjust = 0.5),
          legend.text = element_text(face = "plain", size = 8),
          legend.title = element_text(face="bold", size=8))
  # ggsave(plot, file=here("data", "3_data", paste(sep="", "risk_iNTS_age",name, ".tiff")), height = 7, width = 12)
  return(plot)
}

# # Subgroup by organism
# STmRisk <- subgrp(iNTS_U5_1996_2024_sumOrg,iNTS_U5_1996_2024_sumOrg$Organism,"Typhimurium","STm")
# SEnRisk <- subgrp(iNTS_U5_1996_2024_sumOrg,iNTS_U5_1996_2024_sumOrg$Organism,"Enteritidis","SEn")
# SppRisk <- subgrp(iNTS_U5_1996_2024_sumOrg,iNTS_U5_1996_2024_sumOrg$Organism,"species","Spp")
# 
# SalmAllOrgs <- bind_rows(STmRisk, SEnRisk, SppRisk)
#plotfunc(SalmAllOrgs,SalmAllOrgs$Organism,"Org")

## Subgroup by YearBand
Risk1996_2000 <- subgrp(iNTS_U5_1996_2024_sumYr,iNTS_U5_1996_2024_sumYr$YearBand3,"1996-2000","_1996_2000")
Risk2001_2005 <- subgrp(iNTS_U5_1996_2024_sumYr,iNTS_U5_1996_2024_sumYr$YearBand3,"2001-2005","_2001_2005")
Risk2006_2010 <- subgrp(iNTS_U5_1996_2024_sumYr,iNTS_U5_1996_2024_sumYr$YearBand3,"2006-2010","_2006_2010")
Risk2011_2015 <- subgrp(iNTS_U5_1996_2024_sumYr,iNTS_U5_1996_2024_sumYr$YearBand3,"2011-2015","_2011_2015")
Risk2016_2020 <- subgrp(iNTS_U5_1996_2024_sumYr,iNTS_U5_1996_2024_sumYr$YearBand3,"2016-2020","_2016_2020")
Risk2021_2024 <- subgrp(iNTS_U5_1996_2024_sumYr,iNTS_U5_1996_2024_sumYr$YearBand3,"2021-2024","_2021_2024")

SalmAllYr <- bind_rows(Risk1996_2000, Risk2001_2005, Risk2006_2010,Risk2011_2015,Risk2016_2020,Risk2021_2024)

Risk1996_2000a <- subgrp(iNTS_U5_1996_2024_sumYra,iNTS_U5_1996_2024_sumYra$YearBand3,"1996-2000","_1996_2000")
Risk2001_2005a <- subgrp(iNTS_U5_1996_2024_sumYra,iNTS_U5_1996_2024_sumYra$YearBand3,"2001-2005","_2001_2005")
Risk2006_2010a <- subgrp(iNTS_U5_1996_2024_sumYra,iNTS_U5_1996_2024_sumYra$YearBand3,"2006-2010","_2006_2010")
Risk2011_2015a <- subgrp(iNTS_U5_1996_2024_sumYra,iNTS_U5_1996_2024_sumYra$YearBand3,"2011-2015","_2011_2015")
Risk2016_2020a <- subgrp(iNTS_U5_1996_2024_sumYra,iNTS_U5_1996_2024_sumYra$YearBand3,"2016-2020","_2016_2020")
Risk2021_2024a <- subgrp(iNTS_U5_1996_2024_sumYra,iNTS_U5_1996_2024_sumYra$YearBand3,"2021-2024","_2021_2024")

SalmAllYra <- bind_rows(Risk1996_2000a, Risk2001_2005a, Risk2006_2010a,Risk2011_2015a,Risk2016_2020a,Risk2021_2024a)
# plotfunc(SalmAllYr,SalmAllYr$YearBand3,"Yr")

## All serovars
SalmAllYr <- SalmAllYr %>% mutate(across(where(is.numeric), round, 2))
peakInc <- SalmAllYr %>% group_by(YearBand3) %>% slice_max(risk_pred) %>% ungroup()
meanPeakAge <- round(mean(peakInc$midage), digits=1)
PeakAgeLow <- peakInc %>% slice_min(midage)
PeakAgeHi <- peakInc %>% slice_max(midage)
PeakIncLow <- peakInc %>% slice_min(risk_pred)
PeakIncHi <- peakInc %>% slice_max(risk_pred)

neoInc <- SalmAllYr %>% filter(agemth_rnd==0) %>% mutate(midage = round(midage*30.25, digits=2))
meanNeoAge <- round(mean(neoInc$midage), digits=1)
NeoAgeLow <- neoInc %>% slice_min(midage)
NeoAgeHi <- neoInc %>% slice_max(midage)
NeoIncLow <- neoInc %>% slice_min(risk_pred)
NeoIncHi <- neoInc %>% slice_max(risk_pred)

troughInc <- SalmAllYr %>% group_by(YearBand3) %>% slice_max(risk_pred) %>% ungroup()
meantroughAge <- round(mean(troughInc$midage), digits=1)
troughAgeLow <- troughInc %>% slice_min(midage)
troughAgeHi <- troughInc %>% slice_max(midage)
troughIncLow <- troughInc %>% slice_min(risk_pred)
troughIncHi <- troughInc %>% slice_max(risk_pred)

## Vaccine-Preventable
SalmAllYra <- SalmAllYra %>% mutate(across(where(is.numeric), round, 2))
peakInca <- SalmAllYra %>% group_by(YearBand3) %>% slice_max(risk_pred) %>% ungroup()
meanPeakAgea <- round(mean(peakInca$midage), digits=1)
PeakAgeLowa <- peakInca %>% slice_min(midage)
PeakAgeHia <- peakInca %>% slice_max(midage)
PeakIncLowa <- peakInca %>% slice_min(risk_pred)
PeakIncHia <- peakInca %>% slice_max(risk_pred)

neoInca <- SalmAllYra %>% filter(agemth_rnd==0) %>% mutate(midage = round(midage*30.25, digits=2))
meanNeoAgea <- round(mean(neoInca$midage), digits=1)
NeoAgeLowa <- neoInca %>% slice_min(midage)
NeoAgeHia <- neoInca %>% slice_max(midage)
NeoIncLowa <- neoInca %>% slice_min(risk_pred)
NeoIncHia <- neoInca %>% slice_max(risk_pred)

troughInca <- SalmAllYra %>% group_by(YearBand3) %>% slice_max(risk_pred) %>% ungroup()
meantroughAgea <- round(mean(troughInca$midage), digits=1)
troughAgeLowa <- troughInca %>% slice_min(midage)
troughAgeHia <- troughInca %>% slice_max(midage)
troughIncLowa <- troughInc %>% slice_min(risk_pred)
troughIncHia <- troughInca %>% slice_max(risk_pred)

## Total BC collected
CSF_BC <- import(here("data","3_data", "BC_CSF_all_neg_pos_2015_JUNE2022.xlsx")) %>% 
  row_to_names(5) %>% 
  clean_names() %>% 
  mutate(sampledate = as.numeric(dsp), 
         patient_age = as.numeric(patient_age),
         sampledate = as.Date(sampledate, origin = "1899-12-30"),
         year = year(sampledate),
         age_months = ifelse(age_unit == 'Years', patient_age*12, 
                            ifelse(age_unit == 'Months', patient_age,
                                  ifelse(age_unit == 'Days', patient_age/30.25, patient_age))),
         age_years = age_months/12)

CSF_BC_summ <- CSF_BC %>% 
  filter(age_months<=60) %>% 
  mutate(agebin = cut(age_months, breaks=seq(0,60,1))) %>% 
  group_by(year, agebin) %>% 
  summarise(total = n()) %>% 
  ungroup()

CSF_BC_sumyr <- CSF_BC %>% 
  filter(age_months<=60) %>% 
  mutate(agebin = cut(age_months, breaks=seq(0,60,12))) %>% 
  group_by(year, agebin) %>% 
  summarise(total = n()) %>% 
  ungroup()

peakBCLow <- CSF_BC_summ %>% slice_min(total)
peakBCHi <- CSF_BC_summ %>% slice_max(total)
peakBCLowY <- CSF_BC_sumyr %>% slice_min(total)
peakBCHiY <- CSF_BC_sumyr %>% slice_max(total)
lowBCLow <- CSF_BC_sumyr %>% slice_min(total)
lowBCHi <- CSF_BC_sumyr %>% slice_max(total)
```

\newpage

<!-- changing the orientation to portrait --------------------------------- -->

```{=tex}
\KOMAoptions{usegeometry, paper=portrait,pagesize}
\recalctypearea
```
### Age incidence in children under 5 years
#### All non-typhoidal Salmonella serovars

For children under 5 years of age, predicted incidence of iNTS due to any NTS serovar in the first month of life ranged from `{r} print(NeoIncLow$risk_pred)` (95% CI, `{r} print(NeoIncLow$risk_low)` - `{r} print(NeoIncLow$risk_high)`) per 100,000 child-years in `{r} print(NeoIncLow$YearBand3)` to `{r} print(NeoIncHi$risk_pred)` (95% CI, `{r} print(NeoIncHi$risk_low)` - `{r} print(NeoIncHi$risk_high)`) per 100,000 child-years in `{r} print(NeoIncHi$YearBand3)`, with a mean age of `{r} print(meanNeoAge)` days. The estimated peak of iNTS incidence was `{r} print(PeakAgeLow$risk_pred)` (95% CI,`{r} print(PeakAgeLow$risk_pred)` - `{r} print(PeakAgeLow$risk_pred)`) per  100,000 child-years at `{r} print(PeakAgeLow$midage)` months of age in `{r} print(PeakAgeLow$YearBand3)` to `{r} print(PeakIncHi$risk_pred)` (95% CI,`{r} print(PeakIncHi$risk_low)` - `{r} print(PeakIncHi$risk_high)`) at `{r} print(PeakIncHi$midage)` months of age in `{r} print(PeakIncHi$YearBand3)`. The estimated incidence of iNTS at 60 months of age was lowest at `{r} print(troughAgeLow$risk_pred)` (95% CI,`{r} print(troughAgeLow$risk_pred)` - `{r} print(troughAgeLow$risk_pred)`) per 100,000 child-years at `{r} print(troughAgeLow$midage)` months of age in `{r} print(troughAgeLow$YearBand3)` and highest estimated incidence was `{r} print(troughIncHi$risk_pred)` (95% CI,`{r} print(troughIncHi$risk_low)` - `{r} print(troughIncHi$risk_high)`) at `{r} print(troughIncHi$midage)` months of age in `{r} print(troughIncHi$YearBand3)` (@fig-splineInc).

#### Salmonella typhimurium and Salmonella enteriditis

When restricted to S.typhimurium & S.enteritidis isolates only in children under 5 years, the predicted incidence in the first month of life ranged from `{r} print(NeoIncLowa$risk_pred)`  (95% CI, `{r} print(NeoIncLowa$risk_low)` - `{r} print(NeoIncLowa$risk_high)`) per 100,000 child-years in `{r} print(NeoIncLowa$YearBand3)` to `{r} print(NeoIncHia$risk_pred)` (95% CI, `{r} print(NeoIncHia$risk_low)` - `{r} print(NeoIncHia$risk_high)`)  per 100,000 child-years in `{r} print(NeoIncHia$YearBand3)`, with a mean age of `{r} print(meanNeoAgea)` days. The estimated peak incidence was `{r} print(PeakAgeLowa$risk_pred)`  per  100,000 child-years at `{r} print(PeakAgeLowa$midage)` months of age in `{r} print(PeakAgeLowa$YearBand3)` to `{r} print(PeakIncHia$risk_pred)` at `{r} print(PeakIncHia$midage)` months of age in `{r} print(PeakIncHia$YearBand3)`. The at 60 months of age was lowest at `{r} print(troughAgeLowa$risk_pred)` (95% CI,`{r} print(troughAgeLowa$risk_pred)` - `{r} print(troughAgeLowa$risk_pred)`) per 100,000 child-years at `{r} print(troughAgeLowa$midage)` months of age in `{r} print(troughAgeLowa$YearBand3)` and highest estimated incidence was `{r} print(troughIncHia$risk_pred)` (95% CI,`{r} print(troughIncHia$risk_low)` - `{r} print(troughIncHia$risk_high)`) at `{r} print(troughIncHia$midage)` months of age in `{r} print(troughIncHia$YearBand3)` (@fig-splineIncStmen).

### Blood culture collection and impact of COVID

Age distribution of all collected blood cultures at QECH data was available for 2010 to 2022 (fig-BCColAge). Numbers of blood cultures collected in children in the first year of life ranged from `{r} peakBCLowY$total` in `{r} peakBCLowY$year` to `{r} peakBCHiY$total`  in `{r} peakBCHiY$year`, with the highest numbers collected from neonates (in first 28 days of life) `{r} peakBCLow$total` in `{r} peakBCLow$year` to `{r} peakBCHi$total` in `{r} peakBCLow$year`. The age group with the lowest number of blood cultures collected was `{r} lowBCLow$total` in `{r} lowBCLow$year` to `{r} lowBCHi$total` in `{r} lowBCHi$year`. 

Segmented regression, with harmonic terms to account for seasonal trends in blood culture collection, was useed to assess the impact of COVID-19 pandemic on blood culture collection at QECH-MLW, estimating hypothetical counterfactual blood culture collection numbers if there had been no COVID. Between 01 January 2016 and 01 June 2022, a total of 71,346 paediatric blood cultures were collected through the QECH/ MLW blood culture service. Prior to COVID-19 (Jan 2016 - March 2020) there were 50,990 paediatric blood cultures collected, with an increasing trend of 1.4% (1 to 1.7%) per month, peaking at 1785 cases (701.1 per 100,000) in October 2019 with a trough of 529 (218.6 per 100,000) in July 2017. A total of 9831 blood cultures were taken through TyVAC passive surveillance between March 2018 and June 2021, constituting on average 18% (Median 16.5% IQR: 10.5% 25.3% of all blood cultures collected through the QECH-MLW service during this period) with cessation of study activity during the first wave of covid April-August 2020. 	

Following the onset of the COVID-19 pandemic in Malawi (1st April 2020) ¬¨there was an immediate decrease of 82.7% (95% CI 70.1 to 90%) in blood culture collection rates (figure 2). There was a change in rate of 1.4% (0.5 to 2.3%) per month, resulting in observed blood culture collections rates of 480 and 198 per 100,000 child-years in March and April 2020 respectively, compared to a predicted rates of 589 and 193 per 100,000 in March and April 2020 in the counterfactual scenario of no COVID-19. The case detection rates did not recover during the study period (up to 01 June 2021), with observed rates of 280 and 298 per 10,000 child-years in May and June 2021 respectively, compared to predicted rates of 596 and 570 respectively.


\newpage

<!-- changing the orientation to landscape --------------------------------- -->

```{=tex}
\KOMAoptions{usegeometry, paper=landscape,pagesize}
\recalctypearea
```
```{r echo=FALSE, warning=FALSE, results='hide',ft.align = "centre", ft.width = 7, out.width = "7.5in"}
#| fig-height: !expr size_list$fig_height
#| fig-width: !expr size_list$fig_width
#| label: fig-splineInc
#| fig-cap: Minimum Incidence of Non-Typhoidal Salmonella blood culture isolates in children aged 0-60 months by time period, Queen Elizabeth Central Hospital (QECH), 1996-2024

SalmAllYr %>%
  ggplot() +
  geom_line(aes(y=risk_pred, x=midage), colour="firebrick", size=0.5) +
  geom_ribbon(aes(ymax=risk_high, ymin=risk_low, x=midage), fill="red", alpha=0.3 ) +
  geom_point(aes(y=risk, x=midage), size=0.5, shape=1, colour="firebrick") +
  theme_bw() +
  scale_x_continuous(breaks = c(seq(0,60,6))) +
  xlab("Mid-age in months") +
  ylab("Incidence per 100,000 population") +
  # ggtitle("iNTS incidence in children 0-60 months Blantyre, Malawi (1996-2024)") +
  coord_cartesian(xlim = c(0,60), ylim = c(0,1500))+
  theme(title = element_text(face = "bold", size=6),
        axis.title = element_text(face= "bold" , size = 6),
        axis.text = element_text(face = "plain", size = 6),
        axis.text.x = element_text(face = "plain", size = 6, vjust = 0.5),
        # legend.title = element_text(face = "bold", size = 6), 
        # legend.text = element_text(face = "plain", size = 6), 
        strip.text.x = element_text(face="bold", size = 8))+
  facet_wrap(~YearBand3, scales = "free") +
  coord_panel_ranges(panel_ranges = list(
    list(x=c(0,60), y=c(0,1500)), # Panel 1
    list(x=c(0,60), y=c(0,1500)), # Panel 2
    list(x=c(0,60), y=c(0,1500)), # Panel 3
    list(x=c(0,60), y=c(0,600)),  # Panel 4
    list(x=c(0,60), y=c(0,600)),  # Panel 5
    list(x=c(0,60), y=c(0,600))  # Panel 6
  ))
# ggsave(here("outputs", "risk_iNTS_ageYr_facet.tiff"), height = 7, width = 12)

```

```{r echo=FALSE, warning=FALSE, results='hide',ft.align = "centre", ft.width = 7, out.width = "7.5in"}
#| fig-height: !expr size_list$fig_height
#| fig-width: !expr size_list$fig_width
#| label: fig-splineIncStmen
#| fig-cap: Minimum Incidence of Non-Typhoidal Salmonella blood culture isolates in children aged 0-60 months by time period, Queen Elizabeth Central Hospital (QECH), 1996-2024 (STm and SEn only)
#| 
SalmAllYra %>%
  ggplot() +
  geom_line(aes(y=risk_pred, x=midage), colour="orchid2", size=0.5) +
  geom_ribbon(aes(ymax=risk_high, ymin=risk_low, x=midage), fill="orchid4", alpha=0.3 ) +
  geom_point(aes(y=risk, x=midage), size=0.5, shape=1, colour="orchid2") +
  theme_bw() +
  scale_x_continuous(breaks = c(seq(0,60,6))) +
  xlab("Mid-age in months") +
  ylab("Incidence per 100,000 population") +
  # ggtitle("iNTS incidence in children 0-60 months Blantyre, Malawi (1996-2024)") +
  coord_cartesian(xlim = c(0,60), ylim = c(0,1500))+
  theme(title = element_text(face = "bold", size=6),
        axis.title = element_text(face= "bold" , size = 6),
        axis.text = element_text(face = "plain", size = 6),
        axis.text.x = element_text(face = "plain", size = 6, vjust = 0.5),
        # legend.title = element_text(face = "bold", size = 6), 
        # legend.text = element_text(face = "plain", size = 6), 
        strip.text.x = element_text(face="bold", size = 8))+
  facet_wrap(~YearBand3, scales = "free") +
  coord_panel_ranges(panel_ranges = list(
    list(x=c(0,60), y=c(0,1500)), # Panel 1
    list(x=c(0,60), y=c(0,1500)), # Panel 2
    list(x=c(0,60), y=c(0,1500)), # Panel 3
    list(x=c(0,60), y=c(0,600)),  # Panel 4
    list(x=c(0,60), y=c(0,600)),  # Panel 5
    list(x=c(0,60), y=c(0,600))  # Panel 6
  ))
# ggsave(here("outputs", "risk_iNTS_ageYr_facet.tiff"), height = 7, width = 12)


```

\newpage

<!-- % changing the orientation to portrait again -------------------------- -->

```{=tex}
\KOMAoptions{usegeometry, paper=portrait,pagesize}
\recalctypearea
```


```{r echo=FALSE, results='hide', warning=FALSE, message=FALSE, fig.width=5.5, fig.height=7, fig.align = "left"}
#| label: fig-BCColAge
#| fig-cap: Number of paediatric blood cultures collected through the Queen Elizabeth Hospital- Malawi-Liverpool Wellcome Reseach Program by age in years
#| 

bc1 <- CSF_BC %>% 
  filter(age_months<=1200) %>% 
  ggplot()+
  geom_histogram(aes(age_years), fill="deepskyblue", binwidth = 2)+
  #ggtitle("Age-distribution of collected blood cultures")+
  xlab("Age Years")+
  theme_bw() +
  facet_wrap(~ year) +
  theme(axis.title = element_text(size = 6),
        axis.text = element_text(size = 6),
        strip.text = element_text(size=6))

bc2 <- CSF_BC %>% 
  filter(age_months<=60) %>% 
  ggplot()+
  geom_histogram(aes(age_years), fill="orchid", binwidth = 1)+
  #ggtitle("Age-distribution of collected blood cultures")+
  xlab("Age Years")+
  theme_bw() +
  facet_wrap(~ year) +
  theme(axis.title = element_text(size = 6),
        axis.text = element_text(size = 6),
        strip.text = element_text(size=6))

cowplot::plot_grid(bc1,bc2, labels = "AUTO", nrow=2)
```

![Segmented regression (interrupted time series analysis) of blood cultures collected pre and post COVID, at Queen Elizabeth Hospital, Blantyre, Malawi January 2016 - April 2022](figures/6_images/bc_harmonics.jpeg){#fig-ITS width="656"}

```{r echo=FALSE, results='hide', warning=FALSE, message=FALSE, fig.align = "left"}
### AMR
### By Percent
AMR_paeds_sumMDR_p <- AMR_paeds2 %>% 
  group_by(ageband) %>% 
  summarise(total = n(), 
            MDR = (sum(MDR, na.rm = T)/total)*100,
            R = (sum(R, na.rm = T)/total)*100,
            R = R-MDR,
            S = 100-(MDR+R)) %>% 
  filter(!is.na(ageband))

AMR_paeds_sumMDR_long <- AMR_paeds_sumMDR_p %>% 
  pivot_longer(cols = c(MDR, R,S), names_to = "AMR", values_to = "perc.")%>% 
  filter(!is.na(ageband))

## By counts
AMR_paeds_sumMDR_n <- AMR_paeds2 %>% 
  group_by(ageband) %>% 
  summarise(total = n(), 
            MDR = sum(MDR, na.rm = T),
            R = sum(R, na.rm = T),
            R = R-MDR,
            S = total-(MDR+R)) %>% 
  filter(!is.na(ageband))

AMR_paeds_sumMDR_long_n <- AMR_paeds_sumMDR_n %>% 
  pivot_longer(cols = c(MDR, R,S), names_to = "AMR", values_to = "Total")%>% 
  filter(!is.na(ageband))

### Organism
### By Percent
AMR_paeds_sumOrg_p <- AMR_paeds2 %>% 
  group_by(ageband) %>% 
  summarise(total = n(), 
            STm = (sum(STm, na.rm = T)/total)*100,
            SEn = (sum(SEn, na.rm = T)/total)*100,
            Spp = (sum(Spp, na.rm = T)/total)*100) %>% 
  filter(!is.na(ageband))

AMR_paeds_sumOrg_p_long <- AMR_paeds_sumOrg_p %>% 
  pivot_longer(cols = c(STm, SEn,Spp), names_to = "Serotype", values_to = "perc.")%>% 
  filter(!is.na(ageband))

AMR_paeds_sumOrg_n <- AMR_paeds2 %>% 
  group_by(ageband) %>% 
  summarise(total = n(), 
            STm = sum(STm, na.rm = T),
            SEn = sum(SEn, na.rm = T),
            Spp = sum(Spp, na.rm = T)) %>% 
  filter(!is.na(ageband))

AMR_paeds_sumOrg_long_n <- AMR_paeds_sumOrg_n %>% 
  pivot_longer(cols = c(STm, SEn, Spp), names_to = "Serotype", values_to = "Total") %>% 
  filter(!is.na(ageband))

```
### Antimicrobial resistance

Non-typhoidal salmonella serotypes in children 0 - 10 years of age were `{r} print(AMR_paeds_sumOrg_n$STm)`

```{r echo=FALSE, results='hide', warning=FALSE, message=FALSE, fig.align = "left"}
# fig.height = 5, fig.width = 5.5, out.width = "6in"
#| fig-height: !expr size_list$fig_height
#| fig-width: !expr size_list$fig_width
#| label: fig-AMR
#| fig-cap: Antimicrobial resistance in Non-Typhoidal Salmonella isolates in children at QECH, Blantyre. Isolates were described as ‚Äòfully susceptible‚Äô (S) if susceptible to these 5 antimicrobials (cotrimoxazole, ampicillin, chloramphenicol, cefpodoxime, ciprofloxacin) and resistant (R) if had resistance to 1 or 2 of these antimicrobials, and multidrug resistant (MDR) if resistant to ampicillin, cotrimoxazole, and chloramphenicol.

p1 <- ggplot(AMR_paeds_sumMDR_long, aes(x=ageband, y=perc., fill = AMR))+
  geom_bar(position="stack", stat="identity")+
  xlab("Age") +
  ylab("Percentage") +
  scale_fill_manual(values = c("firebrick2", "goldenrod2", "seagreen3"))+
  theme_bw()+
  theme(axis.title = element_text(face= "bold" , size = 6),
        axis.text = element_text(face = "plain", size = 6),
        axis.text.x = element_text(face = "plain", size = 6, vjust = 0.5, angle=45),
        legend.text = element_text(size = 6),
        legend.title  = element_text(face = "bold", size = 6))


p2 <- ggplot(AMR_paeds_sumMDR_long_n, aes(x=ageband, y=Total, fill = AMR))+
  geom_bar(position="stack", stat="identity")+
  xlab("Age") +
  ylab("Total isolates") +
  scale_fill_manual(values = c("firebrick2", "goldenrod2", "seagreen3"))+
  theme_bw()+
  theme(axis.title = element_text(face= "bold" , size = 8),
        axis.text = element_text(face = "plain", size = 6),
        axis.text.x = element_text(face = "plain", size = 6, vjust = 0.5, angle=45),
        legend.text = element_text(size = 6),
        legend.title  = element_text(face = "bold", size = 8))


p3 <- ggplot(AMR_paeds_sumOrg_p_long, aes(x=ageband, y=perc., fill = Serotype))+
  geom_bar(position="stack", stat="identity")+
  xlab("Age") +
  ylab("Percentage") +
  scale_fill_manual(values = c("gold2","orchid", "mediumpurple2"))+
  theme_bw()+
  theme(axis.title = element_text(face= "bold" , size = 8),
        axis.text = element_text(face = "plain", size = 6),
        axis.text.x = element_text(face = "plain", size = 6, vjust = 0.5, angle=45),
        legend.text = element_text(size = 6),
        legend.title  = element_text(face = "bold", size = 8))


p4 <- ggplot(AMR_paeds_sumOrg_long_n, aes(x=ageband, y=Total, fill = Serotype))+
  geom_bar(position="stack", stat="identity")+
  xlab("Age") +
  ylab("Total isolates") +
  scale_fill_manual(values = c("gold2","orchid", "mediumpurple2"))+
  theme_bw()+
  theme(axis.title = element_text(face= "bold" , size = 8),
        axis.text = element_text(face = "plain", size = 6),
        axis.text.x = element_text(face = "plain", size = 6, vjust = 0.5, angle=45),
        legend.text = element_text(size = 6),
        legend.title  = element_text(face = "bold", size = 8))

cowplot::plot_grid(p1,p2,p3,p4, labels = "AUTO", label_size = 8)

# #### Plot trends over time
# AMR_paeds_sumyr <- AMR_paeds2 %>% 
#   group_by(ageband, year) %>% 
#   summarise(total = n(), 
#             MDR = sum(MDR, na.rm = T),
#             R = sum(R, na.rm = T),
#             R = R-MDR,
#             S = total-(MDR+R)) %>% 
#   filter(!is.na(ageband)) 
# 
# AMR_paeds_sumyr %>% 
#   filter(!is.na(ageband) & ageband!="") %>% 
#     ggplot(aes(x=year, y=MDR, colour = ageband))+
#     geom_point()+
#     geom_line()+
#     xlab("Year") +
#     ylab("Total") +
#     guides(colour = guide_legend(title = "Age Band"))+
#     theme_bw()+
#     theme(axis.title = element_text(face= "bold" , size = 8),
#           axis.text = element_text(face = "plain", size = 6),
#           axis.text.x = element_text(face = "plain", size = 6, vjust = 0.5, angle=45),
#           legend.text = element_text(size = 6),
#           legend.title  = element_text(face = "bold", size = 8))
```

## Discussion

The incidence of invasive non-typhoidal salmonella rose to an epidemic peak in 2002 has been declining since an

There are differences between the methodologies used between sites in Malawi, Burkina Faso and Kenya on these field sites (explored in [@carey_surveillance_2020]), which make it difficult to directly compare these data, and adjusting crude data to give an adjusted incidence adds additional variability and has not yet been undertaken for the Malawi estimates. However, the most directly comparable data sets, on crude unadjusted incidence (see below) in the relevant age-bands, suggest that Malawi could have the highest age-linked incidences of iNTS.

More granular data on incidence in children under 5 years is a key contribution to the literature, particularly to form vaccine development


Put table in intro?

+------------------+------------------+--------+----------------------------+--------+----------------------------+--------+
| Country          |                  |        | Crude incidence,           |        | Adjusted incidence         |        |
|                  |                  |        |                            |        |                            |        |
|                  |                  |        | iNTS cases per 100,000 PYO |        | iNTS cases per 100,000 PYO |        |
+==================+==================+========+============================+========+============================+========+
| **Malawi**       |                  |        |                            |        |                            |        |
+------------------+------------------+--------+----------------------------+--------+----------------------------+--------+
|                  | Age 0-11 months  |        | 80 (22-205)                |        | n/a                        |        |
+------------------+------------------+--------+----------------------------+--------+----------------------------+--------+
|                  | Age 12-23 months |        | 124 (45-269)               |        | n/a                        |        |
+------------------+------------------+--------+----------------------------+--------+----------------------------+--------+
|                  | Age 24-35 months |        | 41 (1-156)                 |        | n/a                        |        |
+------------------+------------------+--------+----------------------------+--------+----------------------------+--------+
|                  | Age 36-47 months |        | 18 (0-130)                 |        | n/a                        |        |
+------------------+------------------+--------+----------------------------+--------+----------------------------+--------+
| **Ghana**        |                  |        |                            |        |                            |        |
+------------------+------------------+--------+----------------------------+--------+----------------------------+--------+
|                  | Under 2 years    |        | 7.9                        |        | 82 (61 - 110)              |        |
+------------------+------------------+--------+----------------------------+--------+----------------------------+--------+
|                  | 2-4 years        |        | 11.0                       |        | 167 (124 - 219)            |        |
+------------------+------------------+--------+----------------------------+--------+----------------------------+--------+
| **Burkina Faso** |                  |        |                            |        |                            |        |
+------------------+------------------+--------+----------------------------+--------+----------------------------+--------+
|                  | Under 2 years    |        | 18.7                       |        | 339 (245 - 497)            |        |
+------------------+------------------+--------+----------------------------+--------+----------------------------+--------+
|                  | 2-4 years        |        | 36.3                       |        | 605 (486 - 772)            |        |
+------------------+------------------+--------+----------------------------+--------+----------------------------+--------+
| Kenya (2014)     |                  |        |                            |        |                            |        |
+------------------+------------------+--------+----------------------------+--------+----------------------------+--------+

: Crude and Adjusted incidence rates for iNTS disease in Malawi, Burkina Faso, and Kenya. The Malawi incidence was estimated from the community-based STRATAA study (Meiring et al, Lancet Infectious Disease 2021). The incidences from Ghana and Burkina Faso are estimated from the SEAP study (unpublished data, personal communication from investigators).

Kenya [@verani2015]

![](figures/3_images/Kenya_iNTS_age.jpg){width="495"}



### Limitations

Many ages coded as 0, particularly pre 2010???? so difficult to tell which are neonates and which are unknown age. Reporting on electronic systems means that age has been captured more accurately since 2010?\>?? However, as this is a time after the iNTS epidemic in Malawi, it is unclear if the age-stratifed incidence has changed during this time and during the epidemic neonatal disease was the peak of disease, or the age distribution has remained more consistent over time. Neonatal blood cultures account for the highest proportion of all blood cultures collected at QECH, and this has remained relatively stable over the time period that data was available to measure this over. Therefore
